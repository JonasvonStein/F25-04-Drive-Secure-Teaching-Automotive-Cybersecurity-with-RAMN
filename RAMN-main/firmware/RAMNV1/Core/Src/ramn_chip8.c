/*
 * ramn_chip8.c
 ******************************************************************************
 * @attention
 *
 * <h2><center>&copy; Copyright (c) 2025 TOYOTA MOTOR CORPORATION.
 * ALL RIGHTS RESERVED.</center></h2>
 *
 * This software component is licensed by TOYOTA MOTOR CORPORATION under BSD 3-Clause license,
 * the "License"; You may not use this file except in compliance with the
 * License. You may obtain a copy of the License at:
 *                        opensource.org/licenses/BSD-3-Clause
 *
 ******************************************************************************
 */

#include "ramn_chip8.h"

#ifdef ENABLE_CHIP8

// Used to read joystick input
#include "ramn_sensors.h"
#include "ramn_dbc.h"

/*=====================================================================*
 *                            Private global                             *
 *======================================================================*/

/*
0x000-0x1FF - Reserved area (contains fonts, etc.)
0x200-0xFFF - Actual game memory
 */

// Interpreter memory
// TODO: put these in heap?
__attribute__ ((section (".buffers"))) static uint8_t memory[CHIP8_MEMORY_SIZE];
// Current opcode
static uint16_t opcode;
// Working registers
static uint8_t V[16];
// RPL registers (for super chip)
static uint8_t RPL[8];
// Memory pointer
static uint16_t I;
// Program Counter
static uint16_t PC;

// Stack of interpreter
static uint16_t stack[32];
// Stack Pointer
static uint16_t SP;
// Status of each Key. Note that some keys are ignored or redundant since RAMN does not feature 16 keys.
static uint16_t keys = 0x0000;
static uint8_t delayTimer;
static uint8_t soundTimer;

// Keeps track of which keys are being pressed, only used by FX0A opcode
static uint16_t keysWaitingRelease = 0x0000;

#define DEFAULT_SCREEN_X 24U
#define DEFAULT_SCREEN_Y 46U
#define DEFAULT_SCREEN_WIDTH 64U
#define DEFAULT_SCREEN_HEIGHT 32U
#define SCREEN_BUFFER_SIZE ((MAX_SCREEN_WIDTH * MAX_SCREEN_HEIGHT) / 8)

// Values below may be impacted by super chip mode
static uint16_t screenStartX = DEFAULT_SCREEN_X;
static uint16_t screenStartY = DEFAULT_SCREEN_Y;
static uint8_t pixelSize = DEFAULT_PIXEL_SIZE;
static uint8_t screenWidth = DEFAULT_SCREEN_WIDTH;
static uint8_t screenHeight = DEFAULT_SCREEN_HEIGHT;
static RAMN_Bool_t extended = False;

// screenBuffer is used for CHIP8 pixel status.
// spriteBuffer is used to actually draw on the screen (SPI buffer).
// TODO: put these in heap?
__attribute__ ((section (".buffers"))) static uint8_t screenBuffer[SCREEN_BUFFER_SIZE];
__attribute__ ((section (".buffers"))) static uint16_t spriteBuffer[SPRITE_BUFFER_HEIGHT*SPRITE_BUFFER_WIDTH*DEFAULT_PIXEL_SIZE*DEFAULT_PIXEL_SIZE] __attribute__ ((section (".buffers")));

static uint16_t backColor = COLOR_BLACK;
static uint16_t frontColor = COLOR_WHITE;

static RAMN_Bool_t screenInitialized = False;
static RAMN_Bool_t gameStarted = False;
static uint32_t lastTimerUpdate = 0;

static unsigned const char CHIP8_FONT[240U] =
{
		// Low Resolution
		0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
		0x20, 0x60, 0x20, 0x20, 0x70, // 1
		0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
		0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
		0x90, 0x90, 0xF0, 0x10, 0x10, // 4
		0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
		0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
		0xF0, 0x10, 0x20, 0x40, 0x40, // 7
		0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
		0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
		0xF0, 0x90, 0xF0, 0x90, 0x90, // A
		0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
		0xF0, 0x80, 0x80, 0x80, 0xF0, // C
		0xE0, 0x90, 0x90, 0x90, 0xE0, // D
		0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
		0xF0, 0x80, 0xF0, 0x80, 0x80,  // F

		// High Resolution
		0x3C, 0x7E, 0xE7, 0xC3, 0xC3, 0xC3, 0xC3, 0xE7, 0x7E, 0x3C,
		0x18, 0x38, 0x58, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C,
		0x3E, 0x7F, 0xC3, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xFF, 0xFF,
		0x3C, 0x7E, 0xC3, 0x03, 0x0E, 0x0E, 0x03, 0xC3, 0x7E, 0x3C,
		0x06, 0x0E, 0x1E, 0x36, 0x66, 0xC6, 0xFF, 0xFF, 0x06, 0x06,
		0xFF, 0xFF, 0xC0, 0xC0, 0xFC, 0xFE, 0x03, 0xC3, 0x7E, 0x3C,
		0x3E, 0x7C, 0xC0, 0xC0, 0xFC, 0xFE, 0xC3, 0xC3, 0x7E, 0x3C,
		0xFF, 0xFF, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x60, 0x60,
		0x3C, 0x7E, 0xC3, 0xC3, 0x7E, 0x7E, 0xC3, 0xC3, 0x7E, 0x3C,
		0x3C, 0x7E, 0xC3, 0xC3, 0x7F, 0x3F, 0x03, 0x03, 0x3E, 0x7C
};

/*=====================================================================*
 *                            Public global                             *
 *======================================================================*/

//Example games from https://github.com/JohnEarnest/chip8Archive

//Cave Explorer
const uint8_t CAVE_EXPLORER[] = {0x1e,0xa5,0x20,0x20,0x20,0x00,0x20,0xf0,0x10,0x70,0x00,0x40,0xe0,0x90,0xe0,0x90,0x90,0x90,0xe0,0x90,0xe0,0x90,0xe0,0x80,0x80,0xd0,0xb0,0xb0,0x90,0x90,0x90,0x90,0x60,0x60,0x90,0x90,0x90,0x60,0x90,0xd0,0xb0,0x90,0x90,0x90,0x50,0x20,0x40,0x00,0x00,0x00,0x00,0x00,0x60,0x90,0xf0,0x90,0x90,0xf0,0x90,0x90,0xf0,0x80,0xe0,0x80,0x80,0x80,0x80,0xf0,0x80,0xe0,0x80,0xf0,0x40,0x40,0x40,0xf0,0x20,0x40,0x80,0xf0,0x20,0x20,0x20,0xc0,0x60,0x90,0x80,0x90,0x60,0x90,0x90,0xb0,0x70,0x80,0xb0,0x90,0x70,0x80,0x60,0x10,0xe0,0x90,0xa0,0xc0,0xa0,0x90,0x90,0xb0,0xb0,0xd0,0xf0,0x40,0x40,0x40,0x40,0x90,0x90,0x70,0x10,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0x21,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x01,0x00,0x00,0x00,0x00,0x0f,0xc0,0x4f,0x81,0x00,0x00,0x00,0x00,0x10,0x30,0x46,0x01,0x00,0x00,0x00,0x00,0x20,0x08,0x20,0x02,0x00,0x00,0x00,0x00,0x30,0xe8,0x20,0x02,0x00,0x00,0x00,0x00,0x4f,0x04,0x10,0x0c,0x00,0x00,0x00,0x00,0x50,0x84,0x1f,0xf6,0x00,0x00,0x00,0x00,0x40,0x04,0x77,0x09,0x00,0x00,0x00,0x00,0x4f,0x84,0x97,0x90,0xc0,0x00,0x00,0x00,0x50,0x4c,0x0e,0xe0,0x20,0x00,0x00,0x00,0x20,0x1e,0x0c,0x00,0x10,0x00,0x00,0x00,0x7f,0xff,0x0a,0x41,0x32,0x0c,0x71,0x2d,0x3a,0x1f,0x0a,0x2d,0x2d,0x2d,0x5e,0x52,0x35,0x1f,0x1f,0x3d,0x05,0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x24,0x1f,0x00,0x35,0x1f,0x67,0x2d,0x32,0x10,0x1f,0x1a,0x6c,0x2d,0x2d,0x2d,0x2d,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x70,0x00,0x00,0x00,0x3e,0x00,0x70,0x3c,0x8c,0x7f,0x00,0x01,0xc1,0x81,0x88,0x42,0x84,0x80,0xe0,0x02,0x00,0x42,0x04,0x42,0x84,0x80,0x10,0x04,0x00,0x44,0x02,0x21,0x04,0x80,0x10,0x08,0x00,0x44,0x01,0x21,0x05,0x00,0x10,0x10,0x03,0x88,0x01,0x10,0x05,0x07,0x10,0x14,0x07,0x08,0x00,0x90,0x45,0x0f,0xd0,0x10,0x0c,0x08,0x60,0x90,0x09,0x06,0x70,0x20,0x18,0x08,0x70,0x90,0x09,0x01,0xa0,0x20,0x18,0x10,0xb0,0x54,0x19,0x00,0x80,0x28,0x10,0x10,0x90,0x4c,0x1a,0x07,0x00,0x20,0x10,0xd0,0xf0,0xa8,0x32,0x46,0x60,0x20,0x0f,0x58,0x00,0x28,0xb2,0x03,0x90,0x29,0x20,0xd1,0x00,0x24,0x33,0x00,0x10,0x30,0x09,0xd4,0x72,0x17,0x73,0x40,0x10,0x14,0x43,0x98,0xf8,0xb6,0x63,0x02,0x10,0x1a,0xa7,0x1b,0x9a,0x33,0x61,0xd0,0x30,0x0d,0x1e,0x1f,0x8d,0x63,0xc1,0xfa,0xd0,0x0f,0xfc,0x0d,0x07,0xe1,0x81,0xff,0x70,0x04,0x60,0x00,0x02,0xc0,0x00,0x8c,0x20,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfb,0x37,0x98,0x73,0xcf,0xbc,0x00,0x00,0xfb,0xf7,0xd8,0xfb,0xef,0xbe,0x00,0x00,0xc1,0xe6,0xd8,0xdb,0x6c,0x36,0x00,0x00,0xf0,0xc7,0xd8,0xdb,0xef,0x3e,0x00,0x00,0xc1,0xe7,0x98,0xdb,0xcc,0x3c,0x00,0x00,0xfb,0xf6,0x1e,0xfb,0x6f,0xb6,0x00,0x00,0xfb,0x36,0x1e,0x73,0x6f,0xb6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x3d,0x97,0xff,0xff,0xff,0xff,0xfd,0xff,0x9d,0x4b,0xff,0x8b,0x47,0x20,0x04,0x00,0x5d,0xcb,0xff,0xd8,0x4f,0x26,0x04,0x00,0x1d,0x05,0xff,0xdb,0x5f,0x21,0x04,0x00,0x1d,0x85,0xff,0xdb,0x47,0x20,0x84,0x7c,0x1c,0x05,0xff,0xff,0xff,0x20,0x84,0xda,0x5d,0xc5,0xff,0x8b,0x47,0x20,0x94,0xbc,0xdd,0xe5,0xff,0x99,0x5b,0x20,0xb4,0xe6,0x1d,0xe6,0x1f,0xba,0x5b,0x20,0x94,0xc2,0xdd,0xcf,0xe7,0x8b,0x47,0x20,0x85,0x7d,0xdc,0x3f,0xf9,0xff,0xff,0x2f,0xf5,0x83,0x9f,0xff,0xfe,0xff,0xff,0x20,0x05,0xff,0x1f,0xff,0xff,0x7f,0xff,0xff,0xfc,0xfe,0x1f,0xff,0xf3,0xbf,0x07,0xff,0xfc,0xfe,0x1f,0xff,0xed,0xde,0xfb,0xa2,0x2d,0xf8,0x0c,0x07,0xdd,0xed,0xfd,0x2a,0xa8,0x07,0xf7,0xf9,0xd9,0xe3,0x7e,0xaa,0xab,0xff,0xec,0x1e,0xd6,0xf3,0xfe,0xa2,0x25,0xf8,0x00,0x06,0xe7,0x1b,0xfe,0xff,0xfa,0x07,0xf8,0x03,0x77,0xc0,0x7e,0x00,0x0b,0xbf,0xfe,0x03,0x7b,0xf8,0xfc,0xff,0xfb,0x9f,0xff,0x81,0x7c,0xed,0xf8,0x00,0x0b,0xbf,0xff,0x81,0x7f,0x0e,0x00,0xff,0xfb,0xaf,0xf0,0x61,0x7f,0xee,0x60,0xff,0xfb,0xba,0x3f,0xf9,0x7f,0xdc,0x98,0xff,0xfd,0xbd,0xff,0xfe,0x3f,0xdc,0xf8,0xff,0xfd,0xbc,0xff,0xff,0xcf,0xdc,0xfc,0x00,0x01,0xbd,0x7f,0xff,0xf1,0xbc,0xfc,0xff,0xfd,0xbd,0xbf,0x00,0x0e,0x3c,0xdc,0x00,0x01,0x1d,0xc8,0xff,0xff,0x8f,0xde,0x00,0x00,0x1d,0xf3,0xff,0xff,0xf3,0xbe,0x00,0x00,0x04,0xfb,0xff,0xff,0xfc,0x7c,0xf8,0x71,0x1f,0x1a,0x2d,0x35,0x41,0x32,0x0a,0x2d,0x2d,0x2d,0x2d,0x32,0x2d,0x0a,0x1a,0x17,0x10,0x3d,0x41,0x2d,0x45,0x24,0x2d,0x6c,0x35,0x41,0x2d,0x0c,0x45,0x5e,0x6c,0x32,0x24,0x52,0x41,0x4d,0x1a,0x5e,0x6c,0x2d,0x32,0x2d,0x10,0x1a,0x24,0x52,0x35,0x1f,0x3a,0x2d,0x5a,0x1f,0x3d,0x0c,0x05,0x2d,0x35,0x1f,0x67,0x1a,0x5e,0x41,0x3d,0x41,0x5e,0x5e,0x00,0x52,0x3d,0x45,0x17,0x10,0x45,0x24,0x5a,0x2d,0x1f,0x1a,0x6c,0x71,0x1f,0x1a,0x2d,0x41,0x17,0x41,0x0a,0x5a,0x41,0x2d,0x2d,0x6c,0x1f,0x2d,0x0c,0x32,0x49,0x49,0x3d,0x45,0x24,0x5a,0x2d,0x5e,0x1a,0x24,0x3d,0x45,0x5a,0x35,0x6c,0x32,0x2d,0x27,0x45,0x5e,0x45,0x1f,0x24,0x2d,0x1f,0x3a,0x2d,0x32,0x2d,0x12,0x71,0x0a,0x32,0x17,0x45,0x0c,0x05,0x2d,0x32,0x5e,0x41,0x52,0x0a,0x41,0x6c,0x2d,0x67,0x32,0x3d,0x3d,0x05,0x5e,0x1f,0x17,0x41,0x1f,0x24,0x41,0x2d,0x3d,0x41,0x3a,0x6c,0x6c,0x35,0x41,0x45,0x0a,0x2d,0x5e,0x63,0x1a,0x3d,0x3d,0x2d,0x35,0x41,0x0a,0x41,0x05,0x2d,0x5a,0x0a,0x1f,0x5e,0x5e,0x00,0x71,0x1f,0x1a,0x2d,0x17,0x1a,0x5e,0x6c,0x2d,0x2d,0x2d,0x2d,0x0a,0x41,0x6c,0x1a,0x0a,0x24,0x2d,0x6c,0x1f,0x2d,0x2d,0x2d,0x67,0x35,0x41,0x0a,0x41,0x2d,0x6c,0x35,0x45,0x5e,0x2d,0x2d,0x32,0x3d,0x3d,0x2d,0x10,0x41,0x5a,0x32,0x24,0x32,0x2d,0x0c,0x41,0x32,0x0c,0x2d,0x41,0x24,0x0c,0x05,0x2d,0x24,0x1a,0x6c,0x5e,0x00,0x5e,0x24,0x67,0x41,0x67,0x00,0xe0,0x60,0x00,0x61,0x00,0x62,0x00,0x63,0x01,0xd0,0x11,0xf3,0x1e,0x72,0x01,0x70,0x08,0x40,0x40,0x71,0x01,0x40,0x40,0x60,0x00,0x31,0x20,0x16,0xaa,0x00,0xee,0x61,0x02,0x62,0x01,0x63,0x00,0xa0,0x00,0xf3,0x1e,0xf0,0x65,0xa2,0x02,0xf0,0x1e,0xd1,0x25,0x71,0x05,0x41,0x3e,0x72,0x06,0x41,0x3e,0x61,0x02,0x73,0x01,0x53,0x40,0x16,0xc6,0x00,0xee,0x60,0x80,0xf0,0x15,0xf0,0x07,0x30,0x00,0x16,0xe8,0x00,0xee,0xa5,0xa4,0x60,0x04,0x61,0x16,0xd0,0x11,0x60,0x34,0x61,0x1d,0xd0,0x11,0x00,0xee,0x60,0xa3,0x61,0x78,0xa6,0xc6,0xf1,0x55,0x64,0x13,0x26,0xc0,0x00,0xee,0x60,0xa3,0x61,0x8b,0xa6,0xc6,0xf1,0x55,0x64,0x0c,0x26,0xc0,0x00,0xee,0x60,0xa3,0x61,0x97,0xa6,0xc6,0xf1,0x55,0x64,0x0d,0x26,0xc0,0x00,0xee,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0xfe,0x55,0x22,0x88,0x00,0x00,0x00,0x00,0x00,0x00,0x11,0x91,0x8b,0x8f,0xdf,0xc3,0xbd,0xbd,0xbd,0xb9,0xb9,0xbd,0xbd,0x81,0x7e,0x5a,0x7e,0x7e,0x5a,0x7e,0x81,0xe7,0xe7,0xc3,0x81,0x82,0x42,0xdb,0x93,0xe7,0xe7,0xc3,0x81,0x41,0x42,0xdb,0xc9,0x04,0x01,0x01,0x03,0x01,0x01,0x03,0x00,0x02,0x01,0x01,0x01,0x01,0x01,0x01,0x03,0x00,0x02,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x02,0x02,0x02,0x02,0x01,0x06,0x04,0x01,0x03,0x01,0x03,0x01,0x01,0x01,0x02,0x01,0x01,0x01,0x01,0x01,0x01,0x05,0x00,0x01,0x01,0x06,0x01,0x01,0x02,0x02,0x00,0x01,0x02,0x02,0x01,0x05,0x00,0x00,0x03,0x01,0x01,0x01,0x01,0x01,0x01,0x04,0x01,0x01,0x01,0x02,0x02,0x02,0x02,0x02,0x05,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x02,0x05,0x01,0x01,0x06,0x01,0x01,0x05,0x01,0x01,0x01,0x01,0x03,0x01,0x01,0x03,0x04,0x01,0x06,0x01,0x01,0x01,0x01,0x05,0x02,0x01,0x02,0x01,0x01,0x01,0x02,0x02,0x00,0x01,0x00,0x05,0x01,0x01,0x00,0x00,0x05,0x01,0x03,0x00,0x03,0x01,0x01,0x04,0x01,0x01,0x01,0x03,0x01,0x01,0x01,0x02,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x02,0x02,0x01,0x06,0x01,0x05,0x02,0x00,0x04,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x02,0x01,0x01,0x06,0x01,0x05,0x01,0x05,0x00,0x01,0x01,0x02,0x01,0x01,0x01,0x01,0x00,0x01,0x01,0x00,0x01,0x05,0x01,0x05,0x00,0x03,0x01,0x05,0x01,0x01,0x01,0x04,0x03,0x01,0x01,0x01,0x01,0x01,0x01,0x02,0x01,0x01,0x01,0x05,0x02,0x01,0x01,0x00,0x05,0x05,0x01,0x06,0x00,0x01,0x01,0x00,0x03,0x03,0x01,0x04,0x01,0x05,0x03,0x03,0x05,0x05,0x01,0x01,0x01,0x01,0x05,0x05,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x02,0x01,0x01,0x06,0x01,0x01,0x01,0x05,0xa7,0x6a,0x00,0xee,0xa7,0x8a,0x00,0xee,0xa7,0xaa,0x00,0xee,0xa7,0xca,0x00,0xee,0xa7,0xea,0x00,0xee,0xa8,0x0a,0x00,0xee,0xa8,0x2a,0x00,0xee,0xa8,0x4a,0x00,0xee,0x80,0xee,0x80,0x0e,0xb8,0x6a,0x68,0x00,0x28,0x8a,0xf8,0x1e,0xf7,0x65,0xa3,0xa4,0xf8,0x1e,0xf7,0x55,0x78,0x08,0x38,0x20,0x18,0x92,0x00,0xee,0x80,0x0e,0x80,0x0e,0x80,0x0e,0xa7,0x2a,0xf0,0x1e,0x00,0xee,0x6a,0x00,0x69,0x00,0x8d,0x10,0x8d,0xd6,0x8d,0xd6,0x8d,0xd6,0x8c,0x20,0x8c,0xc6,0x8c,0xc6,0x8c,0xc6,0x00,0xee,0x28,0x90,0x00,0xe0,0x61,0x00,0x62,0x00,0x63,0x00,0xa3,0xa4,0xf3,0x1e,0xf0,0x65,0x40,0x06,0x28,0xb2,0x28,0xa6,0xd1,0x28,0x73,0x01,0x71,0x08,0x41,0x40,0x72,0x08,0x41,0x40,0x61,0x00,0x32,0x20,0x18,0xd2,0x00,0xee,0x80,0x2e,0x80,0x0e,0x80,0x0e,0x80,0x14,0xa3,0xa4,0xf0,0x1e,0x00,0xee,0x28,0xf2,0xf0,0x65,0x28,0xa6,0x81,0x1e,0x81,0x1e,0x81,0x1e,0x82,0x2e,0x82,0x2e,0x82,0x2e,0xd1,0x28,0x00,0xee,0x81,0x30,0x82,0x40,0x00,0xee,0x29,0x16,0x29,0x00,0x29,0x16,0x28,0xf2,0x80,0x50,0xf0,0x55,0x29,0x16,0x29,0x00,0x00,0xee,0x81,0xd0,0x82,0xc0,0x00,0xee,0x83,0xd0,0x84,0xc0,0x00,0xee,0x29,0x2e,0x81,0x64,0x00,0xee,0x29,0x2e,0x72,0xff,0x00,0xee,0x29,0x2e,0x72,0x01,0x00,0xee,0x29,0x2e,0x29,0x00,0x00,0xee,0x29,0x40,0x28,0xf2,0xf0,0x65,0x00,0xee,0x60,0x00,0x4c,0x00,0x00,0xee,0x29,0x52,0x30,0x05,0x60,0x00,0x40,0x05,0x60,0x01,0x00,0xee,0x67,0x00,0x68,0x07,0x88,0x15,0x3f,0x01,0x00,0xee,0x68,0x03,0x88,0x25,0x3f,0x01,0x00,0xee,0x28,0xf2,0xf0,0x65,0x40,0x01,0x67,0x01,0x40,0x04,0x67,0x01,0x00,0xee,0x29,0x34,0x83,0x64,0x29,0x16,0x72,0x01,0x29,0x6c,0x37,0x01,0x19,0x9e,0x74,0x01,0x19,0x90,0x00,0xee,0x29,0x16,0x28,0xf2,0xf0,0x65,0x40,0x04,0x69,0x01,0x29,0x4c,0x29,0x2e,0x28,0xf2,0x60,0x01,0xf0,0x55,0x29,0x4c,0x8d,0x30,0x8c,0x40,0x65,0x06,0x85,0xa4,0x29,0x1c,0x00,0xee,0x65,0x01,0x29,0x34,0x74,0xff,0x29,0x1c,0x00,0xee,0x65,0x05,0x19,0xc4,0x29,0x34,0x83,0x64,0x74,0xff,0x29,0xa0,0x00,0xee,0x29,0x40,0x81,0x64,0x29,0x6c,0x37,0x01,0x00,0xee,0x29,0x40,0x81,0x64,0x72,0xff,0x29,0x6c,0x37,0x01,0x00,0xee,0x29,0xc2,0x29,0xd0,0x29,0xcc,0x00,0xee,0x29,0x40,0x29,0x6c,0x37,0x01,0x00,0xee,0x29,0x40,0x81,0x64,0x29,0x6c,0x37,0x01,0x00,0xee,0x29,0xd0,0x00,0xee,0x29,0x2e,0x81,0x64,0x29,0x6c,0x37,0x01,0x19,0xda,0x29,0x2e,0x81,0x64,0x72,0xff,0x29,0x6c,0x37,0x01,0x00,0xee,0x29,0xc2,0x29,0x8c,0x29,0xa0,0x29,0xcc,0x00,0xee,0x29,0x5a,0x30,0x00,0x1a,0x0e,0x29,0x2e,0x81,0x64,0x29,0x6c,0x37,0x01,0x19,0xf8,0x29,0x8c,0x29,0xa0,0x00,0xee,0x66,0xff,0x4a,0x00,0x1a,0x2e,0x29,0x34,0x65,0x06,0x29,0x1c,0x6a,0x00,0x00,0xee,0x66,0x01,0x4a,0x01,0x1a,0x2e,0x29,0x34,0x65,0x07,0x29,0x1c,0x6a,0x01,0x00,0xee,0x29,0x3a,0x29,0x6c,0x37,0x01,0x00,0xee,0x29,0x34,0x74,0xff,0x65,0x01,0x29,0x1c,0x29,0x8c,0x65,0x05,0x29,0x1c,0x00,0xee,0x66,0x01,0x4a,0x00,0x66,0xff,0x29,0x5a,0x30,0x00,0x1a,0x64,0x29,0x3a,0x28,0xf2,0xf0,0x65,0x30,0x05,0x00,0xee,0x29,0x52,0x30,0x01,0x00,0xee,0x29,0x34,0x83,0x64,0x65,0x01,0x29,0x1c,0x29,0x34,0x74,0xff,0x65,0x05,0x29,0x1c,0x00,0xee,0x00,0xa3,0x78,0xfd,0x55,0x28,0xc8,0xfb,0x0a,0x4b,0x04,0x28,0xc8,0x4b,0x07,0x2a,0x44,0x4b,0x09,0x2a,0x54,0x4b,0x06,0x2a,0x7c,0x49,0x00,0x1a,0xb1,0x60,0x20,0xf0,0x18,0x00,0xe0,0xaa,0xaa,0xf0,0x65,0x70,0x01,0xaa,0xaa,0xf0,0x55,0xa3,0x78,0xfd,0x65,0x00,0xee,0x00,0x40,0x00,0x00,0x00,0x20,0x40,0x00,0x00,0x40,0x20,0x00,0x00,0x00,0x00,0x00,0x60,0xf0,0xf0,0x60,0x00,0x60,0x60,0x00,0x70,0x40,0xf0,0x50,0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80,0x03,0x06,0x07,0x04,0x0e,0x06,0x07,0x04,0x03,0x03,0x0c,0x04,0x07,0x05,0x07,0x04,0x07,0x06,0x09,0x04,0x0a,0x04,0x0b,0x03,0x05,0x03,0x05,0x03,0x05,0x03,0x05,0x03,0x00,0x02,0x01,0x05,0x0a,0x06,0x07,0x07,0x08,0x09,0x03,0x0c,0x0c,0x0c,0x0c,0x0e,0x03,0x04,0x02,0x01,0x09,0x08,0x06,0x07,0x0a,0x09,0x0a,0x0b,0x0d,0x0e,0x0f,0x0d,0x00,0x02,0x01,0x0a,0x0d,0x03,0x05,0x06,0x08,0x09,0x04,0x0b,0x0b,0x0b,0x0b,0x0b,0x00,0x03,0x02,0x00,0x01,0x05,0x06,0x07,0x05,0x04,0x08,0x0b,0x0d,0x0d,0x03,0x0f,0x28,0xeb,0x0a,0x7a,0x02,0xef,0x28,0x2a,0x6a,0x4a,0x5a,0x42,0x7a,0x0a,0x6e,0x28,0x08,0x08,0x4a,0x08,0xff,0x40,0x5e,0x52,0x42,0x7e,0x40,0xcf,0x08,0x4a,0x08,0x08,0x00,0x70,0x50,0x50,0xd7,0x54,0x54,0x54,0x54,0x54,0x54,0xd5,0x14,0x14,0x7c,0x00,0x28,0x28,0x28,0xeb,0x0a,0x6a,0x0a,0x3a,0x22,0x3a,0x2a,0x2e,0x20,0x38,0x08,0x28,0x08,0x08,0x1c,0x7f,0x5c,0xc9,0x08,0x1c,0x60,0x1c,0x08,0x08,0x1c,0x60,0x1c,0x08,0x10,0x00,0x03,0xf3,0x10,0x10,0x10,0xdf,0xd0,0x16,0x16,0x10,0x10,0x10,0x10,0x10,0x00,0x02,0x4a,0x66,0x70,0x78,0x7c,0xff,0x7c,0x78,0x70,0x66,0x4a,0x02,0x00,0x00,0x00,0x76,0x52,0x5a,0x04,0x00,0x39,0xfb,0x39,0x00,0x04,0x5a,0x52,0x76,0x00,0x00,0x10,0x7e,0x08,0x7e,0x10,0x7e,0x08,0x7e,0x10,0x7e,0x08,0x7e,0x10,0x7e,0x10,0x10,0x08,0x08,0xd8,0x52,0xd0,0x10,0x38,0x2b,0x3a,0x12,0x02,0xc2,0x4e,0x78,0x10,0x18,0x10,0x54,0x10,0xff,0x04,0x7c,0x40,0x7c,0x04,0x1c,0x10,0x00,0x28,0x6c,0x74,0x38,0x00,0xf2,0xea,0x02,0x02,0xc3,0x0a,0xfa,0x02,0xfa,0xa2,0x8a,0x22,0xf2,0x9a,0x38,0x08,0x08,0x08,0x3e,0x22,0xfb,0x22,0x3e,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3e,0x22,0xfb,0x22,0x3e,0x08,0x08,0x08,0x08,0x08,0x08,0x0a,0x08,0x08,0x08,0x08,0x3e,0x22,0xfb,0x22,0x3e,0x08,0x08,0x08,0x08,0x0a,0x08,0x0a,0x08,0x08,0x08,0x08,0x3e,0x22,0xfb,0x22,0x3e,0x08,0x08,0x0a,0x08,0x0a,0x08,0x0a,0x08,0x3d,0x06,0x00,0xee,0x34,0x07,0x00,0xee,0x65,0xfc,0x00,0xee,0x00,0xe0,0x61,0x00,0x64,0x00,0x83,0xde,0x83,0x3e,0x83,0x3e,0x83,0x3e,0xab,0x61,0xf3,0x1e,0xf4,0x1e,0xf0,0x65,0x85,0x00,0x62,0x00,0x2c,0x61,0xaa,0xdd,0xc0,0x0c,0xf0,0x1e,0x85,0x56,0x3f,0x00,0xaa,0xed,0xd1,0x24,0x72,0x04,0x32,0x20,0x1c,0x89,0x71,0x04,0x74,0x01,0x34,0x10,0x1c,0x7b,0x6a,0xff,0x69,0xff,0xa2,0x78,0xfd,0x1e,0xf0,0x65,0x30,0x00,0x00,0xee,0x80,0xde,0xab,0x01,0xf0,0x1e,0xf1,0x65,0x8a,0x00,0x89,0x10,0x80,0x0e,0x80,0x0e,0x81,0x1e,0x81,0x1e,0xaa,0xed,0xd0,0x14,0xaa,0xf5,0xd0,0x14,0x00,0xee,0x80,0xce,0x80,0x0e,0x81,0xbe,0x81,0x1e,0xaa,0xf1,0xd0,0x14,0x00,0xee,0x88,0xc0,0x87,0xb0,0x00,0xee,0x5c,0xa0,0x00,0xee,0x5b,0x90,0x00,0xee,0x66,0x01,0x00,0xee,0xab,0x61,0x80,0xde,0x80,0x0e,0x80,0x0e,0x80,0x0e,0xf0,0x1e,0x63,0x0f,0x82,0xc0,0x82,0x32,0xf2,0x1e,0xf0,0x65,0x81,0x00,0xaa,0xf9,0x63,0x07,0x82,0xb0,0x82,0x32,0xf2,0x1e,0xf0,0x65,0x80,0x12,0x6f,0x01,0x30,0x00,0x2c,0xe5,0x30,0x00,0x00,0xee,0x8c,0x80,0x8b,0x70,0x6f,0x00,0x00,0xee,0xfd,0x1e,0xf0,0x65,0x90,0xd0,0x00,0xee,0x8d,0x00,0x2c,0x6d,0x00,0xee,0x7c,0xff,0x2c,0xf1,0x4f,0x00,0x00,0xee,0x3c,0xff,0x00,0xee,0xab,0x51,0x6c,0x0f,0x1d,0x29,0x7c,0x01,0x2c,0xf1,0x4f,0x00,0x00,0xee,0x3c,0x10,0x00,0xee,0x6c,0x00,0xab,0x31,0x1d,0x29,0x7b,0xff,0x2c,0xf1,0x4f,0x00,0x00,0xee,0x3b,0xff,0x00,0xee,0x6b,0x07,0xab,0x21,0x1d,0x29,0x7b,0x01,0x2c,0xf1,0x4f,0x00,0x00,0xee,0x3b,0x08,0x00,0xee,0x6b,0x00,0xab,0x41,0x1d,0x29,0x42,0x07,0x1d,0x37,0x42,0x09,0x1d,0x49,0x42,0x05,0x1d,0x5b,0x42,0x08,0x1d,0x6d,0x00,0xee,0x60,0x0c,0xf0,0x55,0x00,0xe0,0x60,0xa5,0x61,0xa5,0xa6,0xc6,0xf1,0x55,0x64,0x24,0x26,0xc0,0xf0,0x0a,0x00,0xee,0xab,0xa9,0x2d,0x91,0x00,0xee,0xab,0xae,0x2d,0x91,0x00,0xee,0x00,0xe0,0x60,0xa5,0x61,0xc9,0xa6,0xc6,0xf1,0x55,0x64,0x20,0x26,0xc0,0xf0,0x0a,0x00,0xee,0x00,0xe0,0x60,0xa6,0x61,0x15,0xa6,0xc6,0xf1,0x55,0x64,0x24,0x26,0xc0,0xf0,0x0a,0x00,0xee,0x00,0xe0,0x60,0xa6,0x61,0x39,0xa6,0xc6,0xf1,0x55,0x64,0x24,0x26,0xc0,0xf0,0x0a,0x00,0xee,0x00,0xe0,0x60,0xa6,0x61,0x8a,0xa6,0xc6,0xf1,0x55,0x64,0x11,0x26,0xc0,0xf0,0x0a,0x00,0xee,0x00,0xe0,0x60,0xa6,0x61,0x9b,0xa6,0xc6,0xf1,0x55,0x64,0x05,0x26,0xc0,0xf0,0x0a,0x00,0xee,0x00,0xee,0x6e,0x00,0x2a,0xab,0x00,0xee,0x6e,0x01,0x2a,0xab,0x00,0xee,0x6e,0x02,0x2a,0xab,0x00,0xee,0x6e,0x03,0x2a,0xab,0x00,0xee,0x6e,0x04,0x2a,0xab,0x00,0xee,0x6e,0x05,0x2a,0xab,0x00,0xee,0x6e,0x06,0x2a,0xab,0x00,0xee,0x6e,0x07,0x2a,0xab,0x00,0xe0,0x60,0xa5,0x61,0xe9,0xa6,0xc6,0xf1,0x55,0x64,0x2c,0x26,0xc0,0xf0,0x0a,0xa4,0xa4,0x26,0xa0,0x1e,0x51,0x1e,0x39,0x1d,0xb3,0x1e,0x15,0x1e,0x0f,0x1d,0xad,0x1d,0xd7,0x1e,0x1b,0x1d,0xa7,0x1e,0x21,0x1e,0x33,0x1d,0xe9,0x00,0xee,0x1d,0xc5,0x1e,0x27,0x1d,0xfb,0x1e,0x2d,0xaa,0xaa,0xf0,0x65,0x30,0x07,0x00,0xee,0x70,0x01,0xaa,0xaa,0xf0,0x55,0x00,0xe0,0x60,0xa6,0x61,0x5d,0xa6,0xc6,0xf1,0x55,0x64,0x2d,0x26,0xc0,0xf0,0x0a,0xab,0x31,0x60,0x00,0xf0,0x55,0x00,0xee,0xa2,0x78,0xfd,0x1e,0x60,0x01,0xf0,0x55,0x80,0xde,0xbe,0x53,0xa2,0x78,0x26,0xa0,0x27,0x00,0x26,0xe4,0x27,0x00,0x26,0xf0,0x27,0x0e,0x26,0xe4,0x27,0x0e,0x26,0xf0,0x27,0x1c,0x26,0xe4,0x27,0x1c,0xa3,0xa4,0x26,0xa0,0xf0,0x0a,0x6c,0x0a,0x6b,0x04,0x2c,0x6d,0x2c,0xd1,0xf2,0x0a,0x2c,0xd1,0x2c,0xdf,0x66,0x00,0x2d,0x7f,0x36,0x00,0x2e,0x99,0x2e,0x73,0x36,0x00,0x2c,0x6d,0x1e,0xcb,};
const uint16_t CAVE_EXPLORER_SIZE = sizeof(CAVE_EXPLORER);

//Danm8ku
const uint8_t DANMAKU[] = {0x14,0xe2,0xe0,0x00,0x80,0x79,0x00,0x60,0x0c,0x0c,0x3e,0x0c,0x9b,0xfd,0x20,0x63,0x1c,0x0c,0x3e,0x0c,0xfb,0xcd,0x70,0xe7,0x1c,0x1e,0x23,0x0c,0xf3,0xfd,0xf8,0xcf,0x1e,0x1f,0x21,0x0c,0xc3,0xfd,0xd8,0xcd,0x1e,0x9b,0x21,0x1c,0xe3,0xcd,0xdd,0xdd,0x9e,0xbf,0x21,0x98,0xf3,0x8d,0xcd,0xd9,0x9f,0x3f,0x23,0xf8,0xf9,0x9d,0xcd,0xd9,0xdb,0x71,0x3f,0xf0,0x98,0xf9,0xcd,0xd9,0xd9,0x60,0x3c,0x00,0x00,0xf8,0x00,0x00,0x00,0x00,0x00,0x1e,0x10,0x10,0x10,0x1e,0x10,0x10,0x10,0xea,0xaa,0xaa,0xaa,0xee,0xea,0x8a,0x8e,0x8a,0xea,0xae,0xa8,0x4c,0x48,0x4e,0xe4,0x84,0xe4,0x20,0xe4,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0xa0,0x00,0x00,0x50,0x50,0x00,0x00,0x60,0x60,0x00,0x60,0x00,0x60,0x00,0xc0,0xa0,0x60,0x00,0x30,0x50,0x60,0x00,0x00,0x05,0x0f,0x00,0x00,0x60,0x00,0x60,0x00,0x60,0xa0,0xc0,0x00,0x60,0x50,0x30,0x00,0x60,0x60,0x00,0x00,0xc0,0xc0,0x00,0x00,0x30,0x30,0x00,0xc0,0x60,0xc0,0x00,0x60,0x60,0x00,0x00,0xc0,0xc0,0x00,0x00,0x30,0x30,0x00,0x00,0xa0,0x40,0xa0,0x00,0x00,0x00,0x60,0x60,0x00,0x00,0xc0,0xc0,0x00,0x00,0x30,0x30,0x00,0xe0,0x6a,0x38,0x6b,0x0b,0xa2,0x03,0xda,0xb1,0xf0,0x65,0x7a,0xf8,0x4a,0xf8,0x7b,0x01,0x4a,0xf8,0x6a,0x38,0x3b,0x15,0x12,0xd2,0x64,0x05,0xe4,0xa1,0x00,0xee,0x64,0x07,0xe4,0xa1,0x00,0xee,0x64,0x08,0xe4,0xa1,0x00,0xee,0x64,0x09,0xe4,0xa1,0x00,0xee,0xa2,0x02,0x60,0x00,0xc1,0x1f,0x71,0xf6,0x6f,0x0b,0x8f,0x17,0x4f,0x00,0x12,0xe4,0x71,0x0a,0x62,0x3c,0x40,0x20,0x12,0xe4,0xd0,0x12,0xd2,0x12,0x3f,0x01,0x12,0xe4,0x70,0x04,0x72,0xfc,0x13,0x10,0x00,0xe0,0x63,0x1f,0x65,0x3f,0xa2,0x65,0x60,0x1a,0x61,0x0e,0xd0,0x15,0x70,0x08,0xa2,0x6a,0xd0,0x15,0xa0,0x00,0x60,0x03,0x61,0x01,0x62,0x20,0x66,0x20,0x64,0x20,0x82,0x04,0x86,0x05,0x84,0x15,0x87,0x20,0x8b,0x10,0x23,0x66,0x87,0x60,0x23,0x66,0x8b,0x40,0x23,0x66,0x87,0x20,0x23,0x66,0x70,0x01,0x71,0x01,0x40,0x20,0x70,0x01,0x80,0x52,0x13,0x3c,0x8b,0x32,0x87,0x52,0x6c,0x00,0x6f,0x15,0x8f,0x77,0x4f,0x00,0x7c,0x01,0x6f,0x29,0x8f,0x75,0x4f,0x00,0x7c,0x01,0x6f,0x0a,0x8f,0xb7,0x4f,0x00,0x7c,0x01,0x6f,0x13,0x8f,0xb5,0x4f,0x00,0x7c,0x01,0x6f,0x00,0x8f,0xc5,0x4f,0x00,0xd7,0xb4,0x00,0xee,0x00,0xe0,0xa2,0x5b,0x60,0x19,0x61,0x0d,0xd0,0x15,0xa2,0x60,0x70,0x08,0xd0,0x15,0xf0,0x0a,0xf0,0x0a,0x00,0xee,0x60,0xff,0x24,0x20,0xa2,0x9e,0x83,0x3e,0x83,0x3e,0xf3,0x1e,0xd4,0x54,0x00,0xee,0x8c,0x00,0x80,0x0e,0x8a,0xf0,0x86,0x04,0x80,0xc0,0x8a,0xf2,0x88,0xf0,0x88,0xa5,0x88,0xa5,0x84,0x84,0x8c,0x10,0x81,0x1e,0x8a,0xf0,0x87,0x14,0x81,0xc0,0x8a,0xf2,0x8d,0xf0,0x8d,0xa5,0x8d,0xa5,0x85,0xd4,0x6f,0xfa,0x8f,0x07,0x3f,0x00,0x13,0xf2,0x80,0x24,0x3f,0x00,0x80,0x25,0x83,0x80,0x6f,0x01,0x8f,0x85,0x4f,0x00,0x63,0x02,0x6f,0x01,0x8f,0xd5,0x4f,0x00,0x6d,0x02,0x8d,0xde,0x8d,0xde,0x83,0xd1,0x6f,0x3e,0x8f,0x45,0x3f,0x00,0x14,0x16,0x23,0xac,0x14,0x1e,0x6f,0x1d,0x8f,0x55,0x4f,0x00,0x23,0xac,0x00,0xee,0xab,0xb8,0xfb,0x1e,0xf7,0x55,0x00,0xee,0x6b,0x00,0xab,0xb8,0xfb,0x1e,0xf7,0x65,0x40,0xff,0x14,0x3e,0xa2,0x72,0x83,0x3e,0x83,0x3e,0xf3,0x1e,0xd4,0x54,0x7b,0x08,0x3b,0x00,0x14,0x2a,0x00,0xee,0x6b,0x00,0xab,0xb8,0xfb,0x1e,0xf7,0x65,0x30,0xff,0x23,0xbc,0x30,0xff,0x24,0x20,0x7b,0x08,0x3b,0x00,0x14,0x48,0x00,0xee,0xab,0x54,0xf7,0x55,0xa2,0x8e,0xf0,0x65,0xab,0xb8,0xf0,0x1e,0xf7,0x65,0x68,0x00,0x30,0xff,0x14,0x80,0xa2,0x8e,0xf0,0x65,0x8a,0x00,0x70,0x08,0xa2,0x8e,0xf0,0x55,0x68,0x01,0xab,0x54,0xf7,0x65,0x63,0x00,0xab,0xb8,0xfa,0x1e,0x00,0xee,0xff,0x07,0x3f,0x00,0x14,0x8c,0x6f,0x01,0xff,0x15,0x00,0xee,0xa2,0x8f,0xf1,0x65,0x83,0x16,0x82,0x06,0xa2,0xaa,0xd2,0x33,0x62,0x05,0xe2,0x9e,0x14,0xb0,0x71,0xff,0x41,0x01,0x61,0x02,0x62,0x07,0xe2,0x9e,0x14,0xbc,0x70,0xff,0x40,0x01,0x60,0x02,0x62,0x09,0xe2,0x9e,0x14,0xc8,0x70,0x01,0x40,0x23,0x60,0x22,0x62,0x08,0xe2,0x9e,0x14,0xd4,0x71,0x01,0x41,0x3a,0x61,0x39,0xa2,0x8f,0xf1,0x55,0x83,0x16,0x82,0x06,0xa2,0xaa,0xd2,0x33,0x00,0xee,0x22,0xca,0x69,0x00,0x60,0x00,0xa2,0xad,0xf0,0x55,0x6b,0x00,0xa2,0x6f,0xf7,0x65,0xab,0xb8,0xf7,0x55,0x7b,0x01,0x3b,0x20,0x14,0xf4,0x00,0xe0,0xa2,0x53,0x60,0x39,0x61,0x00,0xd0,0x18,0x71,0x08,0x6f,0x20,0x8f,0x17,0x4f,0x00,0x15,0x04,0xa2,0x8f,0xf1,0x65,0x83,0x16,0x82,0x06,0xa2,0xaa,0xd2,0x33,0x24,0x28,0x24,0x98,0x4f,0x01,0x15,0x34,0x24,0x46,0x8d,0x90,0x25,0x5c,0x4d,0xff,0x25,0x38,0x79,0x01,0x24,0x8c,0x15,0x1c,0x23,0x96,0x14,0xe2,0xa2,0xad,0xf0,0x65,0x70,0x01,0xa2,0xad,0xf0,0x55,0x62,0x3d,0x61,0x01,0x80,0x06,0x3f,0x00,0x15,0x5a,0x40,0x01,0x15,0x56,0x71,0x04,0x70,0xff,0x15,0x4c,0xa2,0xba,0xd2,0x13,0x00,0xee,0xa2,0xad,0xf0,0x65,0x6f,0x01,0x80,0xf2,0x30,0x01,0x15,0x6e,0x4d,0x8c,0x69,0xfe,0x15,0x74,0xa2,0xad,0xf0,0x65,0xb7,0x15,0x00,0xee,0xf7,0x55,0xa2,0x7e,0xd4,0x54,0x00,0xee,0x60,0x07,0x80,0xd2,0x30,0x07,0x15,0x96,0xcc,0x1f,0x24,0x5e,0x62,0x02,0xc0,0x3f,0x70,0xaa,0x64,0x37,0x85,0xc0,0x25,0x76,0x15,0x74,0x60,0x03,0x80,0xd2,0x30,0x03,0x15,0xcc,0xcc,0x1f,0x24,0x5e,0x38,0x01,0x15,0xb6,0xc0,0x7f,0x70,0x7f,0x64,0x39,0x85,0xc0,0x61,0x23,0x62,0x00,0x25,0x76,0xcc,0x1f,0x24,0x5e,0x38,0x01,0x15,0xcc,0xc0,0x7f,0x70,0x7f,0x64,0x39,0x85,0xc0,0x61,0x9b,0x62,0x00,0x25,0x76,0x15,0x74,0x00,0x00,0x00,0xce,0x32,0xd2,0x2e,0xd6,0x2a,0xda,0x26,0xde,0x22,0xe2,0x1e,0xe6,0x1a,0xea,0x16,0xee,0x12,0xf2,0x0e,0xf6,0x0a,0xfa,0x06,0xfe,0x02,0xfa,0x82,0xf6,0x86,0xf2,0x8a,0xee,0x8e,0xea,0x92,0xe6,0x96,0xe2,0x9a,0xde,0x9e,0xda,0xa2,0xd6,0xa6,0xd2,0xaa,0xce,0xae,0xa5,0xce,0xfd,0x33,0xa5,0xce,0xf2,0x65,0x32,0x00,0x16,0x25,0x40,0x01,0x71,0x0a,0x40,0x02,0x71,0x14,0x81,0x1e,0xf1,0x1e,0xf1,0x65,0x24,0x5e,0x64,0x3c,0x65,0x10,0x25,0x76,0x15,0x74,0x60,0x0f,0x80,0xd2,0x30,0x0f,0x16,0x55,0xcc,0x1f,0x64,0x3c,0x85,0xc0,0x60,0x96,0x61,0x00,0x24,0x5e,0x62,0x08,0x25,0x76,0x24,0x5e,0x62,0x04,0x25,0x76,0x64,0x2d,0x60,0x4b,0x24,0x5e,0x61,0x87,0x25,0x76,0x24,0x5e,0x61,0x0a,0x25,0x76,0x15,0x74,0xcc,0x1f,0x24,0x5e,0x64,0x32,0x85,0xc0,0x60,0xe6,0x61,0x00,0x25,0x76,0x24,0x5e,0x64,0x36,0x25,0x76,0x24,0x5e,0x64,0x3a,0x25,0x76,0x00,0xee,0x60,0x1f,0x80,0xd2,0x30,0x1f,0x16,0x91,0xcc,0x1f,0x24,0x5e,0x64,0x23,0x85,0xc0,0x60,0x42,0x61,0x0c,0x62,0x02,0x25,0x76,0x24,0x5e,0x61,0x82,0x25,0x76,0x4d,0x40,0x26,0x57,0x4d,0x80,0x26,0x57,0x4d,0xc0,0x26,0x57,0x15,0x74,0x60,0x07,0x80,0xd2,0x30,0x07,0x16,0xc3,0x60,0x20,0x80,0xd2,0x40,0x00,0x16,0xb5,0x65,0x1c,0x61,0xa0,0x16,0xb9,0x65,0x00,0x61,0x1e,0xc4,0x1f,0x74,0x1f,0x60,0xbe,0x24,0x5e,0x25,0x76,0x15,0x74,0x60,0x07,0x80,0xd2,0x30,0x07,0x16,0xe7,0x60,0x10,0x80,0xd2,0x65,0x1c,0x61,0xa0,0x30,0x00,0x16,0xdd,0x65,0x00,0x61,0x1e,0x60,0x00,0x62,0x00,0xc4,0x1f,0x24,0x5e,0x25,0x76,0x15,0x74,0x60,0x0f,0x80,0xd2,0x30,0x0f,0x17,0x0f,0x85,0xd6,0x85,0x56,0x85,0x56,0x64,0x32,0x60,0x5f,0x61,0x00,0x62,0x05,0x24,0x5e,0x25,0x76,0x61,0x14,0x24,0x5e,0x25,0x76,0x61,0x94,0x24,0x5e,0x25,0x76,0x15,0x74,0x23,0x22,0x14,0xe2,0x15,0x7e,0x15,0x98,0x16,0x03,0x16,0x27,0x16,0x73,0x16,0x9f,0x16,0xc5,0x16,0xe9,0x17,0x11,};
const uint16_t DANMAKU_SIZE = sizeof(DANMAKU);

//Octopeg
const uint8_t OCTOPEG[] = {0x1c,0x16,0x22,0x0a,0x62,0x80,0x22,0x28,0x00,0xee,0x60,0xad,0x61,0x91,0xa2,0x8c,0xf1,0x55,0xa2,0xb4,0xf1,0x55,0x60,0x12,0x61,0xd0,0xa2,0xc8,0xf1,0x55,0x60,0x12,0x61,0xd2,0xa2,0xcc,0xf1,0x55,0x00,0xee,0x65,0x00,0x64,0x01,0x34,0x01,0x12,0x44,0x22,0xa0,0xf0,0x65,0x30,0xff,0x12,0x42,0x45,0x00,0x00,0xee,0x60,0x00,0x64,0x00,0x12,0x44,0x85,0x04,0x22,0x8c,0xf0,0x65,0x83,0x00,0x22,0xc8,0x80,0x30,0x80,0x54,0x6e,0x09,0x8e,0x05,0x4f,0x01,0x12,0x6a,0x70,0xf6,0x83,0x00,0x65,0x01,0x22,0xb4,0xf0,0x55,0x22,0x90,0x22,0xb8,0x80,0x30,0x12,0x72,0x83,0x00,0x65,0x00,0x22,0xb4,0xf0,0x55,0x22,0xcc,0x34,0x01,0x12,0x82,0x35,0x00,0x12,0x80,0x22,0x90,0x22,0xb8,0x22,0xa4,0x80,0x50,0x80,0x44,0x30,0x00,0x12,0x2c,0x00,0xee,0x00,0x00,0x00,0xee,0xa2,0x8c,0xf1,0x65,0x6f,0x01,0x81,0xf4,0x80,0xf4,0xa2,0x8c,0xf1,0x55,0x00,0xee,0x00,0x00,0x00,0xee,0xa2,0xa0,0xf1,0x65,0x6f,0x01,0x81,0xf4,0x80,0xf4,0xa2,0xa0,0xf1,0x55,0x00,0xee,0x00,0x00,0x00,0xee,0xa2,0xb4,0xf1,0x65,0x6f,0x01,0x81,0xf4,0x80,0xf4,0xa2,0xb4,0xf1,0x55,0x00,0xee,0x00,0x00,0x00,0xee,0x00,0x00,0x00,0xee,0x72,0xfb,0xf0,0x29,0x6f,0x01,0xd2,0xf5,0x00,0xee,0x61,0x00,0x62,0x80,0x6e,0x00,0xad,0x91,0xf1,0x1e,0x71,0x01,0xf0,0x65,0x22,0xd0,0x7e,0x01,0x3e,0x06,0x12,0xe0,0x00,0xee,0xf1,0x1e,0x71,0x01,0xf0,0x65,0x40,0xff,0x60,0x00,0xf0,0x29,0xd3,0x45,0x7e,0x01,0x00,0xee,0x63,0x5d,0x64,0x04,0x6e,0x00,0x61,0x00,0xad,0x88,0x73,0xfb,0x22,0xf2,0x3e,0x06,0x13,0x0c,0x6f,0x00,0x61,0x24,0x62,0x04,0xaf,0x9a,0x2e,0xe9,0x3f,0xff,0x13,0x1c,0x00,0xee,0x63,0x5d,0x64,0x04,0x6e,0x00,0x61,0x00,0xad,0x99,0x73,0xfb,0x22,0xf2,0x3e,0x03,0x13,0x2e,0x6f,0x00,0x61,0x24,0x62,0x04,0xaf,0x93,0x2e,0xe9,0x3f,0xff,0x13,0x3e,0x00,0xee,0x63,0x5d,0x64,0x04,0x6e,0x00,0x61,0x00,0x00,0x00,0x73,0xfb,0x22,0xf2,0x3e,0x05,0x13,0x50,0x6f,0x00,0x61,0x24,0x62,0x04,0xaf,0x9f,0x2e,0xe9,0x3f,0xff,0x13,0x60,0x00,0xee,0xad,0xa0,0xf0,0x65,0x61,0x01,0x62,0x01,0xad,0x08,0x6e,0x00,0xd1,0x22,0x7e,0x01,0x71,0x03,0x3e,0x0a,0x13,0x84,0x61,0x01,0x72,0x03,0x5e,0x00,0x13,0x76,0x00,0xee,0xad,0xa0,0xf0,0x65,0x23,0x98,0x70,0xff,0xad,0xa0,0xf0,0x55,0x00,0xee,0x61,0x01,0x62,0x01,0xad,0x08,0x40,0x01,0x13,0xb4,0x6e,0x01,0x71,0x03,0x3e,0x0a,0x13,0xae,0x61,0x01,0x72,0x03,0x7e,0x01,0x5e,0x00,0x13,0xa4,0xd1,0x22,0x00,0xee,0xad,0xa0,0xf0,0x65,0x30,0x14,0x13,0xc2,0x13,0xc4,0x70,0x01,0xad,0xa0,0xf0,0x55,0x23,0x98,0x00,0xee,0x75,0x04,0x75,0x04,0x35,0x00,0x13,0xe6,0xad,0xa3,0xf0,0x65,0x23,0xec,0x70,0x04,0x40,0x28,0x60,0x00,0x23,0xec,0xad,0xa3,0xf0,0x55,0x00,0xee,0xad,0xa3,0xf0,0x65,0xad,0x77,0x62,0x3f,0x24,0xa2,0xd1,0x21,0x00,0xee,0xad,0x0b,0x60,0x08,0x61,0x08,0xd0,0x18,0x60,0x20,0x61,0x00,0xd0,0x18,0x60,0x58,0xad,0x13,0xd0,0x18,0x71,0x08,0x60,0x70,0xd0,0x18,0x60,0x58,0xad,0x3b,0xd0,0x18,0x60,0x20,0xad,0x33,0xd0,0x18,0x60,0x08,0xad,0x1b,0x70,0x08,0xd0,0x18,0x30,0x18,0x14,0x20,0x60,0x58,0x70,0x08,0xd0,0x18,0x30,0x68,0x14,0x2a,0x60,0x20,0x61,0x00,0x70,0x08,0xd0,0x18,0x30,0x50,0x14,0x36,0xad,0x2b,0x60,0x70,0x61,0x08,0x71,0x08,0xd0,0x18,0x31,0x38,0x14,0x44,0xad,0x23,0x60,0x08,0x61,0x08,0x71,0x08,0xd0,0x18,0x31,0x38,0x14,0x52,0x24,0x8e,0x00,0xee,0xad,0x4b,0x60,0x00,0x61,0x38,0xd0,0x18,0x60,0x78,0xd0,0x18,0xad,0x5b,0x61,0x08,0xd0,0x18,0x60,0x00,0xd0,0x18,0xad,0x53,0x71,0x08,0xd0,0x18,0x31,0x30,0x14,0x76,0x61,0x08,0x60,0x78,0x71,0x08,0xd0,0x18,0x31,0x30,0x14,0x82,0x24,0xcc,0x00,0xee,0xad,0x43,0x61,0x17,0x62,0x3a,0x6e,0x00,0xd1,0x26,0x7e,0x01,0x71,0x13,0x3e,0x05,0x14,0x96,0x00,0xee,0xb4,0xa4,0x61,0x0d,0x00,0xee,0x61,0x20,0x00,0xee,0x61,0x33,0x00,0xee,0x61,0x46,0x00,0xee,0x61,0x59,0x00,0xee,0x61,0x6c,0x00,0xee,0x61,0x59,0x00,0xee,0x61,0x46,0x00,0xee,0x61,0x33,0x00,0xee,0x61,0x20,0x00,0xee,0xad,0xa4,0xf0,0x65,0x40,0x00,0x14,0xe4,0x61,0x00,0x62,0x3e,0xad,0x63,0x70,0xff,0x72,0xfe,0xd1,0x22,0x30,0x00,0x14,0xda,0x00,0xee,0xad,0xa4,0xf0,0x65,0x70,0x01,0xad,0xa4,0xf0,0x55,0x61,0x00,0x82,0x0e,0x6f,0x3e,0x82,0xf7,0xad,0x63,0x30,0x1b,0x15,0x20,0x80,0x20,0x6e,0x00,0x82,0x00,0x72,0x02,0x25,0x2a,0x7e,0x01,0x26,0xf0,0x3e,0x09,0x15,0x02,0x60,0x01,0xad,0xa4,0xf0,0x55,0x72,0x02,0xad,0x63,0xd1,0x22,0x23,0xb8,0x00,0xee,0xd1,0x22,0x00,0xee,0xad,0x63,0x61,0x78,0x62,0x0a,0xd1,0x28,0x72,0x08,0xd1,0x28,0x72,0x08,0xd1,0x28,0x72,0x08,0xd1,0x28,0x72,0x08,0xd1,0x28,0x72,0x08,0xd1,0x28,0x72,0x08,0xd1,0x24,0x00,0xee,0xad,0xa5,0xf0,0x65,0x30,0x34,0x15,0x7c,0x81,0x00,0xad,0xa7,0xf0,0x65,0x30,0x00,0x15,0x76,0x6e,0x00,0x6f,0x00,0x61,0x2f,0x62,0x04,0xaf,0x8c,0x2e,0xe9,0x3f,0xff,0x15,0x60,0x7e,0x01,0x26,0xe4,0x3e,0x10,0x15,0x5a,0xad,0xa7,0x60,0x01,0xf0,0x55,0x80,0x10,0x70,0x14,0x00,0xee,0x70,0x01,0xad,0xa5,0xf0,0x55,0x61,0x78,0x82,0x00,0x6f,0x3e,0x82,0xf7,0xad,0x63,0xd1,0x21,0x00,0xee,0x6e,0x00,0x6f,0x00,0x61,0x25,0x62,0x04,0xaf,0x82,0x2e,0xe9,0x3f,0xff,0x15,0x98,0x7e,0x01,0x26,0xe4,0x3e,0x10,0x15,0x92,0x00,0xee,0xd3,0x41,0x00,0xee,0x65,0x08,0x80,0x0e,0x4f,0x01,0x25,0xaa,0x73,0x02,0x75,0xff,0x35,0x00,0x15,0xb0,0x00,0xee,0x00,0x00,0x00,0xee,0xa5,0xc0,0xf1,0x65,0x8f,0x20,0x81,0xf4,0x80,0xf4,0xa5,0xc0,0xf1,0x55,0x00,0xee,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x0e,0x80,0x0e,0x80,0x0e,0x2e,0xa7,0xa5,0xc0,0xf1,0x55,0x66,0x00,0x67,0x00,0x68,0x00,0x69,0x00,0x63,0x10,0x64,0x10,0x25,0xc0,0xf0,0x65,0x6a,0xe0,0x6b,0x1f,0x8a,0x02,0x8b,0x02,0x3a,0x20,0x16,0x36,0xf0,0x65,0x82,0x00,0xad,0x0a,0x80,0x20,0x36,0x06,0x16,0x16,0x66,0x00,0x77,0x01,0x73,0xa0,0x74,0x0a,0x37,0x04,0x16,0x20,0x67,0x00,0x74,0xda,0x78,0x01,0x40,0x00,0x16,0x28,0x25,0xae,0x16,0x2a,0x73,0x10,0x76,0x01,0x7b,0xff,0x3b,0x00,0x16,0x08,0x62,0x02,0x25,0xc4,0x3a,0x40,0x16,0x4e,0x89,0xb0,0x89,0x9e,0x62,0x01,0x25,0xc4,0xa5,0xd4,0xf1,0x55,0x62,0x02,0x25,0xc4,0xa5,0xd6,0xf1,0x55,0x3a,0x60,0x16,0x5c,0xf1,0x65,0x83,0x04,0x84,0x14,0x62,0x03,0x25,0xc4,0x3a,0x80,0x16,0x70,0x66,0x00,0x67,0x00,0x68,0x00,0x69,0x00,0x63,0x10,0x64,0x10,0x62,0x01,0x25,0xc4,0x3a,0xa0,0x16,0x7e,0x8c,0xb0,0x62,0x01,0x25,0xc4,0xa5,0xd8,0xf1,0x55,0x3a,0xc0,0x16,0x96,0x7c,0xff,0x4c,0x00,0x16,0x92,0xa5,0xd8,0xf1,0x65,0xa5,0xc0,0xf1,0x55,0x16,0x96,0x62,0x01,0x25,0xc4,0x49,0x00,0x16,0xb0,0x6f,0x01,0x8f,0x92,0x3f,0x00,0x16,0xa6,0xa5,0xd4,0x16,0xa8,0xa5,0xd6,0xf1,0x65,0xa5,0xc0,0xf1,0x55,0x79,0xff,0x25,0xc0,0xf0,0x65,0x30,0x00,0x15,0xf6,0x00,0xee,0x6f,0x3c,0xff,0x15,0xff,0x07,0x60,0x04,0xe0,0xa1,0x6f,0x00,0x60,0x07,0xe0,0xa1,0x6f,0x00,0x60,0x09,0xe0,0xa1,0x6f,0x00,0x60,0x05,0xe0,0xa1,0x6f,0x00,0x60,0x08,0xe0,0xa1,0x6f,0x00,0x3f,0x00,0x16,0xbe,0x00,0xee,0x6f,0x02,0xff,0x15,0xff,0x07,0x3f,0x00,0x16,0xe8,0x00,0xee,0x6f,0x01,0xff,0x15,0xff,0x07,0x3f,0x00,0x16,0xf4,0x00,0xee,0x6e,0x3d,0x8e,0x77,0x4f,0x01,0x17,0x26,0xad,0x78,0xf5,0x55,0x27,0x66,0x27,0x90,0x27,0xa2,0x80,0x20,0x28,0x36,0x28,0x72,0xad,0x78,0xf5,0x65,0x77,0xff,0x6d,0x01,0x69,0x04,0x88,0x86,0x4c,0x01,0x78,0x80,0x17,0x28,0x29,0x92,0x00,0xee,0x24,0xe6,0x73,0x01,0x25,0x46,0x6f,0xf0,0x8f,0x32,0x3f,0x00,0x25,0x46,0x70,0x02,0x6f,0xf8,0x80,0xf2,0x70,0x08,0x84,0x04,0x3f,0x01,0x17,0x52,0x74,0x9c,0xad,0xa6,0xf0,0x65,0x70,0x01,0xad,0xa6,0xf0,0x55,0xad,0x78,0xf5,0x55,0x27,0x66,0x27,0xa2,0x28,0x26,0x28,0x36,0x28,0x72,0xad,0x78,0xf5,0x65,0x00,0xee,0xad,0x0a,0x80,0x60,0x81,0x70,0x62,0x00,0xd0,0x11,0x3f,0x00,0x17,0x8a,0xd0,0x11,0x72,0x01,0x42,0x01,0x70,0x01,0x42,0x02,0x71,0x01,0x42,0x03,0x70,0xff,0xd0,0x11,0x4f,0x00,0x17,0x74,0x8e,0x26,0x82,0xe3,0x00,0xee,0xd0,0x11,0xad,0x9c,0xf1,0x65,0x86,0x00,0x87,0x10,0xf1,0x65,0x8a,0x00,0x8b,0x10,0x00,0xee,0x3c,0x00,0x17,0xd6,0x38,0x00,0x78,0xff,0x3d,0x00,0x17,0xb2,0x80,0x90,0x17,0xb6,0x60,0x00,0x80,0x95,0x61,0x00,0x8e,0x00,0x8e,0x87,0x3f,0x01,0x71,0x01,0x83,0x06,0x8e,0x30,0x8e,0x87,0x3f,0x01,0x71,0x04,0x83,0x86,0x8e,0x00,0x8e,0x37,0x3f,0x01,0x71,0x02,0x18,0x24,0x38,0x00,0x78,0x01,0x3d,0x00,0x18,0x02,0x60,0x00,0x80,0x85,0x61,0x00,0x8e,0x00,0x8e,0x95,0x3f,0x01,0x71,0x01,0x83,0x96,0x8e,0x30,0x8e,0x07,0x3f,0x01,0x71,0x04,0x83,0x06,0x8e,0x90,0x8e,0x37,0x3f,0x01,0x71,0x02,0x18,0x24,0x61,0x00,0x8e,0x90,0x8e,0x85,0x3f,0x01,0x61,0x01,0x83,0x96,0x73,0x80,0x8e,0x30,0x8e,0x85,0x3f,0x01,0x71,0x04,0x83,0x86,0x73,0x80,0x8e,0x90,0x8e,0x35,0x3f,0x01,0x71,0x02,0x00,0xee,0x60,0x00,0x8e,0xae,0x4f,0x01,0x70,0x01,0x8e,0xbe,0x4f,0x01,0x70,0x02,0x00,0xee,0x6e,0x00,0x6f,0x03,0x8f,0x03,0x92,0x00,0x6e,0x01,0x92,0xf0,0x6e,0x01,0x3e,0x00,0x18,0x68,0x6e,0x02,0x8e,0x22,0x3e,0x00,0x18,0x5c,0x6e,0x02,0x8e,0x02,0x60,0x02,0x4e,0x00,0x60,0x04,0x18,0x66,0x6e,0x02,0x8e,0x02,0x60,0x04,0x4e,0x00,0x60,0x02,0x18,0x6a,0x60,0x01,0x81,0x02,0x31,0x00,0x61,0x01,0x00,0xee,0x2c,0x14,0x6f,0x00,0x32,0x00,0x18,0x88,0x31,0x00,0x18,0x84,0x4c,0x00,0x6f,0x02,0x18,0x88,0x4d,0x00,0x6f,0x01,0x32,0x01,0x18,0x9a,0x31,0x00,0x18,0x96,0x4c,0x01,0x6f,0x02,0x18,0x9a,0x4d,0x00,0x6f,0x01,0x32,0x02,0x18,0xac,0x31,0x00,0x18,0xa8,0x4c,0x00,0x6f,0x02,0x18,0xac,0x4d,0x01,0x6f,0x01,0x32,0x03,0x18,0xbe,0x31,0x00,0x18,0xba,0x4c,0x01,0x6f,0x02,0x18,0xbe,0x4d,0x01,0x6f,0x01,0x4f,0x00,0x18,0xcc,0x4f,0x01,0x29,0x92,0x4f,0x02,0x29,0x88,0x00,0xee,0x8e,0x26,0x8e,0xf3,0x30,0x01,0x18,0xea,0x3e,0x00,0x18,0xdc,0x29,0x88,0x29,0x92,0x8f,0x80,0x88,0x90,0x89,0xf0,0x8f,0xc0,0x8c,0xd0,0x8d,0xf0,0x18,0xec,0x28,0xf0,0x2c,0x14,0x00,0xee,0x83,0x00,0x80,0x86,0x80,0x06,0x81,0x96,0x81,0x16,0x80,0x06,0x4c,0x01,0x70,0xe0,0x81,0x16,0x4d,0x01,0x71,0xe0,0x82,0x16,0x4d,0x01,0x72,0x80,0x3e,0x01,0x19,0x16,0x88,0x10,0x88,0x24,0x19,0x1c,0x68,0x00,0x88,0x15,0x88,0x25,0x33,0x04,0x19,0x24,0x88,0x05,0x19,0x26,0x88,0x04,0x82,0x06,0x4c,0x01,0x72,0x80,0x3e,0x01,0x19,0x36,0x89,0x00,0x89,0x24,0x19,0x3c,0x69,0x00,0x89,0x05,0x89,0x25,0x33,0x04,0x19,0x44,0x89,0x14,0x19,0x46,0x89,0x15,0x88,0x8e,0x3f,0x01,0x19,0x5a,0x88,0x8e,0x4f,0x00,0x68,0x04,0x48,0x00,0x68,0x04,0x6f,0x01,0x19,0x62,0x88,0x8e,0x4f,0x01,0x68,0xfc,0x6f,0x00,0x8c,0xf0,0x89,0x9e,0x3f,0x01,0x19,0x7a,0x89,0x9e,0x48,0x00,0x68,0x04,0x3f,0x00,0x19,0x78,0x69,0x04,0x6f,0x01,0x19,0x84,0x89,0x9e,0x3f,0x01,0x19,0x84,0x69,0xfc,0x6f,0x00,0x8d,0xf0,0x00,0xee,0x6f,0x00,0x89,0xf7,0x6f,0x01,0x8d,0xf3,0x00,0xee,0x6f,0x00,0x88,0xf7,0x6f,0x01,0x8c,0xf3,0x00,0xee,0x80,0x80,0x81,0x90,0x70,0x3d,0x71,0x03,0xd0,0x15,0x00,0xee,0xad,0xa1,0xf1,0x65,0x88,0x00,0x89,0x10,0xad,0x70,0x60,0x3c,0x61,0x03,0xd0,0x17,0xad,0x6b,0x29,0x9c,0x63,0x00,0x6f,0xf0,0x85,0xf2,0x23,0xcc,0x45,0x00,0xad,0x6b,0x29,0x9c,0x60,0x07,0xe0,0xa1,0x78,0xff,0x60,0x09,0xe0,0xa1,0x78,0x01,0x60,0x05,0xe0,0xa1,0x79,0xff,0x60,0x08,0xe0,0xa1,0x79,0x01,0x60,0x06,0xe0,0xa1,0x63,0x01,0x48,0x63,0x78,0x01,0x48,0x9e,0x78,0xff,0x49,0x7f,0x79,0x01,0x49,0x9f,0x79,0xff,0x29,0x9c,0x26,0xe4,0x43,0x00,0x19,0xc2,0x29,0x9c,0x23,0x8a,0xad,0x70,0x60,0x3c,0x61,0x03,0xd0,0x17,0xad,0xa1,0x80,0x80,0x81,0x90,0xf1,0x55,0x63,0x00,0x64,0x9c,0xad,0xa6,0x60,0x00,0xf0,0x55,0x00,0xee,0x29,0xa8,0x66,0x3f,0x67,0x05,0x6a,0x80,0x6b,0x80,0xad,0x08,0xd6,0x72,0x60,0x80,0x61,0x01,0x88,0x04,0x8c,0xf0,0x8c,0x13,0x89,0x04,0x8d,0xf0,0x8d,0x13,0x88,0x8e,0x88,0x8e,0x88,0x8e,0x89,0x9e,0x89,0x9e,0x89,0x9e,0x23,0xce,0xad,0x9c,0x80,0x60,0x81,0x70,0xf1,0x55,0x80,0xa0,0x81,0xb0,0xf1,0x55,0x6e,0x03,0x89,0xe4,0x3f,0x01,0x1a,0x6c,0x3d,0x01,0x1a,0x6a,0x6d,0x00,0x1a,0x6c,0x69,0xfc,0x3c,0x01,0x1a,0x7c,0x6e,0x00,0x8e,0x85,0x8a,0xe5,0x4f,0x00,0x76,0xff,0x1a,0x80,0x8a,0x84,0x86,0xf4,0x3d,0x01,0x1a,0x90,0x6e,0x00,0x8e,0x95,0x8b,0xe5,0x4f,0x00,0x77,0xff,0x1a,0x94,0x8b,0x94,0x87,0xf4,0x6e,0x0c,0x8e,0x77,0x4f,0x01,0x1a,0xd0,0x3d,0x01,0x1a,0xc0,0x6e,0x23,0x8e,0x67,0x4f,0x01,0x1a,0xac,0x67,0x0b,0x29,0x88,0x6e,0x5b,0x8e,0x65,0x4f,0x01,0x1a,0xb8,0x67,0x0b,0x29,0x88,0x37,0x03,0x1a,0xc0,0x67,0x03,0x29,0x88,0x36,0x23,0x1a,0xc8,0x4c,0x01,0x29,0x92,0x36,0x5b,0x1a,0xd0,0x4c,0x00,0x29,0x92,0x3c,0x01,0x1a,0xde,0x36,0x0b,0x1a,0xdc,0x66,0x0b,0x29,0x92,0x1a,0xe6,0x36,0x73,0x1a,0xe6,0x66,0x73,0x29,0x92,0xad,0xa7,0xf0,0x65,0x40,0x00,0x1a,0xfe,0x61,0x02,0x80,0x13,0xad,0xa7,0xf0,0x55,0xaf,0x07,0x61,0x7a,0x62,0x0a,0xd1,0x25,0xad,0x9c,0xf1,0x65,0xad,0x08,0xd0,0x12,0x60,0x04,0xe0,0x9e,0x1b,0x10,0x67,0x3e,0x66,0x00,0x37,0x3e,0x1b,0x16,0x1b,0x36,0xd6,0x72,0x3f,0x01,0x1b,0x36,0x2c,0x14,0xd6,0x72,0x80,0x70,0x70,0x04,0x6e,0x3a,0x8e,0x05,0x4f,0x01,0x1b,0x30,0x26,0xfc,0x1b,0x32,0x27,0x2a,0xad,0x08,0xd6,0x72,0x26,0xf0,0x37,0x3e,0x1a,0x4a,0xad,0xa3,0xf0,0x65,0x24,0xa2,0x71,0xfc,0x81,0x67,0x6e,0x0e,0x8e,0x17,0x4f,0x01,0x1b,0x52,0x23,0xb8,0x25,0x90,0xad,0x99,0xf3,0x33,0xf2,0x65,0x8f,0x20,0x82,0x00,0x80,0xf0,0xad,0x99,0xf2,0x55,0x74,0x64,0xad,0x89,0xf4,0x33,0xf2,0x65,0x8f,0x20,0x82,0x00,0x80,0xf0,0xad,0x89,0xf1,0x55,0xad,0xa6,0xf0,0x65,0xad,0x8b,0x40,0x00,0x1b,0x8c,0xf0,0x33,0xf2,0x65,0x8f,0x20,0x82,0x00,0x80,0xf0,0xad,0x8b,0xf2,0x55,0x60,0xff,0xf0,0x55,0x60,0xad,0x61,0x88,0xa2,0xa0,0xf1,0x55,0x22,0x02,0x2c,0x14,0xad,0xa7,0xf0,0x65,0x8a,0x00,0x4a,0x00,0x1b,0xe8,0x4a,0x01,0x1b,0xb2,0xaf,0x07,0x61,0x7a,0x62,0x0a,0xd1,0x25,0xad,0xa7,0x60,0x00,0xf0,0x55,0x46,0x00,0x1b,0xde,0x60,0x00,0x24,0xa2,0x8e,0x60,0x7e,0x04,0x8e,0x15,0x60,0xf8,0x61,0x13,0x70,0x08,0x8e,0x15,0x4f,0x01,0x1b,0xca,0x2d,0xa8,0xa2,0xa0,0xf1,0x55,0xa3,0x50,0xf1,0x55,0x1b,0xe0,0x6a,0x00,0xad,0xa5,0x60,0x00,0xf0,0x55,0x25,0x24,0x23,0x26,0x26,0xba,0x23,0x26,0x23,0x04,0x26,0xba,0x23,0x04,0x4a,0x00,0x1c,0x0a,0x6a,0x00,0x22,0x02,0x23,0x48,0x26,0xf0,0x23,0x48,0x26,0xf0,0x7a,0x01,0x3a,0x1e,0x1b,0xfc,0xad,0xa0,0xf0,0x65,0x30,0x00,0x1a,0x20,0x00,0xee,0x00,0xee,0x66,0x01,0x6f,0x00,0x61,0x0b,0x62,0x0a,0xaf,0xa5,0x2e,0xe9,0x3f,0xff,0x1c,0x1e,0xa2,0x02,0x64,0x10,0x60,0x00,0x61,0x00,0x62,0x08,0x6e,0x00,0x74,0xff,0x34,0x00,0x1c,0x40,0xc4,0x0f,0x74,0x03,0xa2,0x0a,0xf4,0x1e,0xd0,0x18,0xf2,0x1e,0x70,0x08,0x7e,0x01,0x3e,0x08,0x1c,0x40,0x36,0x01,0x1c,0x64,0x60,0x00,0x61,0x11,0x62,0x0f,0x6e,0x00,0xd0,0x1f,0xf2,0x1e,0x70,0x08,0x7e,0x01,0x3e,0x08,0x1c,0x58,0x61,0x00,0x60,0x07,0xe0,0xa1,0x61,0x01,0x60,0x09,0xe0,0xa1,0x61,0x01,0x60,0x05,0xe0,0xa1,0x61,0x01,0x60,0x08,0xe0,0xa1,0x61,0x01,0x60,0x06,0xe0,0xa1,0x61,0x01,0x26,0xe4,0x41,0x00,0x1c,0x2a,0x00,0xff,0x22,0x0a,0x00,0xe0,0x61,0x07,0xad,0xea,0xf0,0x65,0x80,0x06,0x82,0x06,0x80,0x17,0x80,0x25,0xad,0xa0,0xf0,0x55,0x23,0xf6,0x24,0x5e,0xad,0xea,0xf0,0x65,0x25,0xda,0x22,0xda,0x23,0x6a,0xad,0xa5,0x60,0x00,0xf0,0x55,0x23,0xe8,0x2a,0x20,0xad,0xea,0xf0,0x65,0x70,0x01,0xad,0xea,0xf0,0x55,0x30,0x08,0x1c,0x8e,0x2c,0xcc,0x1c,0x18,0x00,0xe0,0x00,0xfe,0x6f,0x00,0x61,0x02,0x62,0x12,0xaf,0xad,0x2e,0xe9,0x3f,0xff,0x1c,0xd6,0x63,0x32,0x64,0x19,0x6e,0x00,0x61,0x00,0xad,0x91,0x73,0xfb,0x22,0xf2,0x3e,0x07,0x1c,0xe6,0x60,0x00,0x61,0x00,0x62,0x00,0x63,0x00,0xad,0x91,0xf3,0x55,0xf3,0x55,0xad,0xea,0xf0,0x55,0xad,0xa4,0xf0,0x55,0x00,0xee,0xc0,0xc0,0x80,0xff,0x80,0xbf,0xa0,0xa0,0xa0,0xa0,0xa0,0xff,0x01,0xfd,0x05,0x05,0x05,0x05,0x05,0xff,0x00,0xff,0x00,0x00,0x00,0x00,0x00,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0x05,0x05,0x05,0x05,0x05,0x05,0x05,0x05,0xa0,0x20,0xe0,0x00,0x00,0x00,0x00,0x00,0x05,0x04,0x07,0x00,0x00,0x00,0x00,0x00,0x30,0x78,0x78,0xfc,0xfc,0xfc,0xfc,0xfc,0x5a,0x42,0x42,0x42,0x42,0x42,0x7e,0x00,0x5a,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x00,0x7e,0x42,0x42,0x42,0x42,0x42,0x42,0x3c,0x3c,0x3c,0x3c,0x3c,0x3c,0x3c,0x3c,0x20,0x20,0xf8,0x20,0x20,0xbd,0xc3,0xdb,0xdb,0xc3,0x7e,0x3c,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x88,0x00,0x00,0x00,0x00,0x00,0xbd,0xaa,0x60,0xad,0x61,0xe5,0x00,0xee,0x01,0x02,0x60,0xad,0x61,0xe0,0x00,0xee,0x03,0x03,0x60,0xad,0x61,0xda,0x00,0xee,0x04,0x05,0x60,0xad,0x61,0xda,0x00,0xee,0x06,0x07,0x60,0xad,0x61,0xe0,0x00,0xee,0x08,0x09,0x60,0xad,0x61,0xe5,0x00,0xee,0x0a,0x0b,0x08,0x06,0x07,0x02,0x03,0xff,0x00,0x00,0x08,0x06,0xff,0x00,0x00,0x08,0x01,0xff,0x00,0x26,0x44,0x26,0x11,0x26,0x44,0x26,0xaa,0x00,0x38,0x55,0x60,0x00,0x03,0x38,0xaa,0x00,0xa2,0x21,0xff,0x24,0x00,0x21,0xff,0xc0,0x2c,0x00,0xa2,0x21,0xff,0x24,0x00,0x21,0xff,0xc0,0x60,0x01,0x00,0xa2,0x22,0x00,0x22,0x55,0x22,0x00,0xc0,0x38,0xaa,0x00,0xa5,0x38,0x44,0xc0,0x00,0x2c,0x55,0x60,0x01,0x00,0x2c,0x66,0x2c,0x00,0x2c,0x99,0x00,0xa5,0x38,0x88,0x60,0x01,0x00,0xc0,0x00,0x38,0xe0,0x60,0x03,0x00,0x38,0x07,0x60,0xfd,0x00,0x38,0x38,0x60,0x03,0x00,0x38,0xc1,0x00,0x60,0x01,0x00,0x43,0x21,0x07,0x21,0xc0,0x43,0x21,0x7f,0x21,0xfc,0x43,0x21,0xdb,0x21,0xb6,0x43,0x21,0x32,0x21,0x98,0x43,0x21,0x1f,0x21,0xf0,0x43,0x21,0x7f,0x21,0xfc,0x43,0x21,0x7f,0x21,0xfc,0x43,0x21,0x26,0x21,0xc8,0x43,0x21,0x3f,0x21,0xf8,0x43,0x21,0x7f,0x21,0xfc,0x43,0x21,0x1f,0x21,0xf0,0x43,0x21,0x04,0x21,0x40,0x43,0x21,0x3f,0x21,0xf8,0x43,0x21,0x3f,0x21,0xf8,0x43,0x21,0x7f,0x21,0xfc,0x26,0x00,0x43,0x21,0x7f,0x21,0xfc,0x43,0x21,0x1f,0x21,0xf0,0x43,0x21,0xd2,0x21,0x96,0x00,0xbe,0xa9,0x60,0xad,0x61,0xeb,0x00,0xee,0x01,0x02,0x60,0xad,0x61,0xf4,0x00,0xee,0x03,0x03,0x60,0xad,0x61,0xfc,0x00,0xee,0x04,0x05,0x60,0xae,0x61,0x1c,0x00,0xee,0x06,0x07,0x60,0xae,0x61,0x21,0x00,0xee,0x08,0x09,0x60,0xae,0x61,0x2d,0x00,0xee,0x08,0x09,0x60,0xae,0x61,0x35,0x00,0xee,0x0a,0x0b,0x60,0xae,0x61,0x47,0x00,0xee,0x00,0xee,0xff,0x1e,0xf0,0x65,0x30,0xff,0x1e,0xf7,0x6f,0xff,0x00,0xee,0x1f,0x05,0xaf,0x0c,0xf0,0x1e,0x80,0xf0,0xd1,0x25,0x8f,0x00,0x71,0x06,0x7f,0x01,0x00,0xee,0xf0,0x80,0xf0,0x80,0x80,0x90,0xa0,0xc0,0xa0,0x90,0x78,0x80,0x70,0x08,0xf0,0xf8,0x20,0x20,0x20,0x20,0x88,0x50,0x20,0x40,0x80,0xf0,0x88,0xf0,0x88,0xf0,0x80,0x80,0x88,0x50,0x20,0x50,0x88,0xf8,0x88,0xf8,0x80,0xf0,0x80,0x80,0x80,0x80,0xf8,0x88,0x88,0xf8,0x88,0x88,0x88,0x88,0x70,0xf0,0x88,0x88,0x88,0xf0,0x88,0xf0,0x90,0x88,0xd8,0xa8,0x88,0x88,0x50,0x50,0x20,0x78,0x80,0x80,0x80,0x78,0x80,0x98,0x88,0x70,0x88,0x88,0x88,0x70,0x88,0x88,0x98,0x78,0xf8,0x80,0xf0,0x80,0xf8,0x20,0x20,0x20,0xf8,0x10,0x20,0x40,0xf8,0x20,0x20,0x20,0xc0,0x88,0xc8,0xa8,0x98,0x88,0x88,0xa8,0xa8,0x50,0x50,0x50,0x00,0x50,0x00,0x00,0x00,0x00,0x00,0x22,0x36,0x53,0x53,0x71,0x14,0x1d,0x25,0x25,0xff,0x22,0x53,0x3d,0x53,0x36,0x6c,0xff,0x05,0x0a,0x36,0x53,0x1d,0x00,0xff,0x1b,0x0a,0x36,0x1d,0xff,0x14,0x4a,0x64,0x2d,0x05,0xff,0x4a,0x42,0x0a,0x4a,0x16,0x53,0x46,0xff,0x22,0x57,0x64,0x1d,0x25,0x05,0x42,0x4a,0x36,0x53,0xff,};
const uint16_t OCTOPEG_SIZE = sizeof(OCTOPEG);

/*=====================================================================*
 *                          Private functions                           *
 *======================================================================*/

static inline void CHIP8_SetKeyState(uint8_t keyIndex, RAMN_Bool_t pressed)
{
    if (pressed) keys |= (1 << keyIndex);
    else keys &= ~(1 << keyIndex);
}

static inline RAMN_Bool_t CHIP8_GetKeyState(uint8_t keyIndex)
{
    return (keys & (1 << keyIndex)) ? True : False;
}

//Note that this is used to saved the status of the screen, this does not draw on the screen
static inline void CHIP8_SetPixel(uint32_t x, uint32_t y, uint8_t value)
{
    uint32_t index = (y * screenWidth + x);
    uint32_t byteIndex = index / 8U;
    uint8_t bitIndex = index % 8U;

    if (value) screenBuffer[byteIndex] |= (1U << bitIndex);  // Set bit
    else screenBuffer[byteIndex] &= ~(1U << bitIndex); // Clear bit
}

static inline uint8_t CHIP8_GetPixel(uint32_t x, uint32_t y)
{
    uint32_t index = (y * screenWidth + x);
    uint32_t byteIndex = index / 8U;
    uint8_t bitIndex = index % 8U;

    return (screenBuffer[byteIndex] & (1U << bitIndex)) ? 1U : 0U;
}

static void CHIP8_ScrollUpByNPixels(uint8_t n)
{
	for (int x = 0; x < screenWidth; x++) {

		for (int y = n; y < screenHeight; y++) {
			CHIP8_SetPixel(x, y-n, CHIP8_GetPixel(x,y));
		}

		// Fill the rightmost 4 pixels with 0
		for (int y = screenHeight - n; y < screenWidth; y++) {
			CHIP8_SetPixel(x, y, 0U);
		}
	}
}

static void CHIP8_ScrollDownByNPixels(uint8_t n)
{
	for (int x = 0; x < screenWidth; x++) {

		for (int y = screenHeight-n-1; y >= 0 ; y--) {
			CHIP8_SetPixel(x, y+n, CHIP8_GetPixel(x,y));
		}

		// Fill the rightmost 4 pixels with 0
		for (int y = 0; y < n; y++) {
			CHIP8_SetPixel(x, y, 0U);
		}
	}
}

static void CHIP8_ScrollLeftBy4Pixels() {
	uint8_t n = 4;
	if (extended == False) n = 2;
	for (int y = 0; y < screenHeight; y++) {
		for (int x = 0; x < screenWidth - n; x++) {
			CHIP8_SetPixel(x+n, y, CHIP8_GetPixel(x,y));
		}

		// Fill the rightmost 4 pixels with 0
		for (int x = screenWidth - n; x < screenWidth; x++) {
			CHIP8_SetPixel(x, y, 0U);
		}
	}
}

static void CHIP8_ScrollRightBy4Pixels() {
	uint8_t n = 4;
	if (extended == False) n = 2;

	for (int y = 0; y < screenHeight; y++) {
		for (int x = screenWidth-1; x >= n; x--) {
			CHIP8_SetPixel(x-n, y, CHIP8_GetPixel(x,y));
		}

		// Fill the left 4 pixels with 0
		for (int x = 0; x < n; x++) {
			CHIP8_SetPixel(x, y, 0U);
		}
	}
}

/*=====================================================================*
 *                          Public functions                           *
 *======================================================================*/

void RAMN_CHIP8_SetColor(uint16_t fg, uint16_t bg)
{
	frontColor = fg;
	backColor = bg;
}

void RAMN_CHIP8_Init(const uint8_t* game_to_load, uint16_t game_size)
{
	PC     = 0x200;  // game location
	opcode = 0;
	I      = 0;
	SP     = 0;
	delayTimer = 0;
	soundTimer = 0; // Note that this is not implemented since there is no buzzer

	//Clear registers
	for(uint8_t i = 0; i < 0x10; i++)
		V[i] = 0;

	//Load font
	for(int i = 0; i < sizeof(CHIP8_FONT); ++i)
		memory[FONT_ADDRESS + i] = CHIP8_FONT[i];

	//Load game
	for(uint16_t i = 0; i < game_size; ++i)
		memory[0x200 + i] = game_to_load[i];

	//Clear RPL
	for (uint8_t i = 0; i < 8; i++)
	{
		RPL[i] = 0;
	}

	for(uint16_t i = 0x200 + game_size; i < sizeof(memory); ++i)
		memory[i] = 0;

	//clear screen
	screenInitialized = False;
	for(uint32_t i = 0; i < sizeof(screenBuffer); i++) screenBuffer[i] = 0;

	for(uint32_t i = 0; i < 16U*16U*3U*3U; i++) spriteBuffer[i] = backColor;

	//Verify that we are in chip 8 mode
	pixelSize = DEFAULT_PIXEL_SIZE;
	extended = False;
	screenStartX = 24;
	screenStartY = 46;
	screenWidth = 64;
	screenHeight = 32;
}

RAMN_Bool_t RAMN_CHIP8_IsGameActive()
{
	return gameStarted;
}

void RAMN_CHIP8_StartGame(uint32_t xLastWakeTime)
{
	lastTimerUpdate = xLastWakeTime;
	gameStarted = True;
}

void RAMN_CHIP8_StopGame()
{
	gameStarted = False;
}

void RAMN_CHIP8_Update(uint32_t xLastWakeTime)
{
	uint8_t X;
	uint8_t Y;
	uint8_t CARRY;

	keys = 0x0000;
	switch((RAMN_DBC_Handle.joystick))
	{
	case RAMN_SHIFT_UP:
		CHIP8_SetKeyState(0x5,True);
		break;
	case RAMN_SHIFT_DOWN:
		CHIP8_SetKeyState(0x8,True);
		break;
	case RAMN_SHIFT_RIGHT:
		CHIP8_SetKeyState(0x9,True);
		break;
	case RAMN_SHIFT_LEFT:
		CHIP8_SetKeyState(0x7,True);
		break;
	case RAMN_SHIFT_PUSH:
		CHIP8_SetKeyState(0x6,True); //redundant with UP
		break;
	}

	if (xLastWakeTime - lastTimerUpdate > 16)
	{
		if (soundTimer > 0) soundTimer -= 1;
		if (delayTimer > 0) delayTimer -= 1;
		lastTimerUpdate = xLastWakeTime;
	}

	if (PC >= (sizeof(memory)-1) || (I >= sizeof(memory))) // PC or I overflow
	{
		gameStarted = False;
		return;
	}
	opcode = memory[PC] << 8 | memory[PC + 1];

	switch (opcode & 0xF000)
	{
	case 0x0000:
		switch (opcode & 0x00FF)
		{
		case 0x0001:
			//Consider Noop
			PC += 2;
			break;
		case 0x00E0:
			for(uint32_t i = 0; i < sizeof(screenBuffer); i++) screenBuffer[i] = 0;
			RAMN_SPI_DrawRectangle(screenStartX, screenStartY, screenWidth*pixelSize, screenHeight*pixelSize, backColor);
			PC += 2;
			break;
		case 0x00EE:
			SP -= 1;
			if (SP >= (sizeof(stack)/sizeof(uint16_t))) //if an underflow happened, quit
			{
				gameStarted = False;
			}
			PC = stack[SP];
			PC += 2;
			break;
		case 0x00FB:
			CHIP8_ScrollRightBy4Pixels();
			RAMN_CHIP8_RedrawScreen();
			PC += 2;
			break;
		case 0x00FC:
			CHIP8_ScrollLeftBy4Pixels();
			RAMN_CHIP8_RedrawScreen();
			PC += 2;
			break;
		case 0x00FD:
			gameStarted = False;
			break;
		case 0x00FE:
			pixelSize = DEFAULT_PIXEL_SIZE;
			extended = False;
			screenStartX = 24;
			screenStartY = 46;
			screenWidth = 64;
			screenHeight = 32;
			PC += 2;
			screenInitialized = False; //redraw
			break;
		case 0x00FF:
			pixelSize = 1;
			screenStartX = 56;
			screenStartY = 64;
			screenWidth = 128;
			screenHeight = 64;
			extended = True;
			PC += 2;
			screenInitialized = False; //redraw
			break;
		default:
			switch (opcode & 0x00F0)
			{
			case 0x00D0:
				CHIP8_ScrollUpByNPixels(opcode&0xF);
				RAMN_CHIP8_RedrawScreen();
				PC += 2;
				break;
			case 0x00C0:
				CHIP8_ScrollDownByNPixels(opcode&0xF);
				RAMN_CHIP8_RedrawScreen();
				PC += 2;
				break;
			default:
				gameStarted = False;
			}
		}
		break;

		case 0x1000:
			PC = opcode & 0x0FFF;
			break;
		case 0x2000:
			stack[SP] = PC;
			SP++;  // incrementing the SP
			if (SP >= (sizeof(stack)/sizeof(uint16_t)))
			{
				gameStarted = False;
			}
			PC = opcode & 0x0FFF;
			break;
		case 0x3000:
			//0x3XNN SKIP NEXT IF VX EQUALS NN
			if (V[(opcode & 0x0F00) >> 8] == (opcode & 0x00FF))
				PC += 2;
			PC += 2;
			break;
		case 0x4000:
			//0x4XNN SKIP NEXT IF VX NOT EQUALS NN
			if (V[(opcode & 0x0F00) >> 8] != (opcode & 0x00FF))
				PC += 2;
			PC += 2;
			break;
		case 0x5000:
			//0xXY0 SKIP NEXT IF VX EQUALS VY
			if (V[(opcode & 0x0F00) >> 8] == V[(opcode & 0x00F0) >> 4])
				PC += 2;
			PC += 2;
			break;
		case 0x6000:
			//0x6XNN SET VX TO NN
			V[(opcode & 0x0F00) >> 8] = opcode & 0x00FF;
			PC += 2;
			break;
		case 0x7000:
			//0x7XNN ADD NN TO VX
			V[(opcode & 0x0F00) >> 8] += (opcode & 0x00FF);
			PC += 2;
			break;
		case 0x8000:
			X = (opcode & 0xF00) >> 8;
			Y = (opcode & 0x00F0) >> 4;
			switch (opcode & 0x000F)
			{
			case 0x0000:
				V[(opcode & 0xF00) >> 8] = V[(opcode & 0x00F0) >> 4];
				PC += 2;
				break;
			case 0x0001:
				V[(opcode & 0xF00) >> 8] |= V[(opcode & 0x00F0) >> 4];
				PC += 2;
				break;
			case 0x0002:
				V[(opcode & 0xF00) >> 8] &= V[(opcode & 0x00F0) >> 4];
				PC += 2;
				break;
			case 0x0003:
				V[(opcode & 0x0F00) >> 8] ^= V[(opcode & 0x00F0) >> 4];
				PC += 2;
				break;
			case 0x0004:
				if (V[(opcode & 0x00F0) >> 4] > (0xFF - V[(opcode & 0x0F00) >> 8]))
					CARRY = 1; //carry
				else
					CARRY = 0;
				V[(opcode & 0x0F00) >> 8] += V[(opcode & 0x00F0) >> 4];
				V[0xF] = CARRY;
				PC += 2;
				break;
			case 0x0005:
				if (V[(opcode & 0x00F0) >> 4] > V[(opcode & 0x0F00) >> 8])
					CARRY = 0;
				else
					CARRY = 1;
				V[(opcode & 0x0F00) >> 8] -= V[(opcode & 0x00F0) >> 4];
				V[0xF] = CARRY;
				PC += 2;
				break;
			case 0x0006:
				CARRY = V[Y] & 0x1;
				V[X] = V[Y] >> 1;
				V[0xF] = CARRY;
				PC += 2;
				break;
			case 0x000E:
				CARRY = (V[Y] >> 7)&0x1;
				V[X] = V[Y] << 1;
				V[0xF] = CARRY;
				PC += 2;
				break;
			case 0x0007:
				if (V[(opcode & 0x0F00) >> 8] > V[(opcode & 0x00F0) >> 4])
					CARRY = 0;
				else
					CARRY = 1;
				V[(opcode & 0x0F00) >> 8] = V[(opcode & 0x00F0) >> 4] - V[(opcode & 0x0F00) >> 8];
				V[0xF] = CARRY;
				PC += 2;
				break;
			default:
				gameStarted = False;
			}
			break;
			case 0x9000:
				// 0x9XY0: SKIP IF NOT EQUAL
				if (V[(opcode & 0x0F00) >> 8] != V[(opcode & 0x00F0) >> 4])
					PC += 2;
				PC += 2;
				break;
			case 0xA000:
				// ANNN: SET I TO NNN
				I = opcode & 0x0FFF;
				PC += 2;
				break;
			case 0xB000:
				// BNNN: JUMP
				PC = (opcode & 0x0FFF) + V[0];
				break;
			case 0xC000:
				//GET RNG
				V[(opcode & 0x0F00) >> 8] = (RAMN_RNG_Pop8() & 0xFF) & (opcode & 0x00FF);
				PC += 2;
				break;
			case 0xD000:
			{
				uint16_t x = V[(opcode & 0x0F00) >> 8];
				uint16_t y = V[(opcode & 0x00F0) >> 4];
				uint16_t height = opcode & 0x000F;
				uint16_t pixels;
				uint8_t wrapping = 0;
				uint8_t width = 8;
				V[0xF] = 0;

				if (screenInitialized == False)
				{
					//Note that we use Chip8 and not super chip8 value because chip8 has the bigger canvas.
					RAMN_SPI_DrawRectangle(DEFAULT_SCREEN_X, DEFAULT_SCREEN_Y, DEFAULT_SCREEN_WIDTH*DEFAULT_PIXEL_SIZE, DEFAULT_SCREEN_HEIGHT*DEFAULT_PIXEL_SIZE, backColor);
					screenInitialized = True;
				}

				if (height == 0)
				{
					if  (extended != False)
					{
						height = 16;
						width = 16;
					}
					else
					{
						height = 16;
						width = 16;
					}
				}
				uint16_t shift_mask = 0x80;
				uint8_t redraw_needed = 0U;
				wrapping = x+width > screenWidth || y+height > screenHeight;
				for (uint16_t yline = 0; yline < height; yline++)
				{
					uint16_t color;
					if (height == 16)
					{
						shift_mask = 0x8000;
						pixels = memory[I + yline*2] << 8;
						pixels |= memory[I + yline*2+1];
					}
					else
					{
						shift_mask = 0x80;
						pixels = memory[I + yline];
					}
					for (uint16_t xline = 0; xline < width; xline++)
					{
						uint8_t pixel = (pixels & (shift_mask >> xline)) != 0 ? 1U : 0U;

						if (pixel != 0)
						{
							redraw_needed = 1U;
							if (CHIP8_GetPixel((x + xline)%screenWidth,((y + yline)%screenHeight)) != 0U)
							{
								V[0xF] = 1;
							}
							// swap pixel
							CHIP8_SetPixel((x + xline)%screenWidth,(y + yline)%screenHeight, CHIP8_GetPixel((x + xline)%screenWidth, (y + yline)%screenHeight) ^ pixel);

							//if there is a screen wrap, we draw pixel by pixel
							if (wrapping != 0)
							{
								color = CHIP8_GetPixel((x + xline)%screenWidth, (y + yline)%screenHeight) == 0U ? backColor : frontColor;
								RAMN_SPI_DrawRectangle(screenStartX + ((x + xline)%screenWidth)*pixelSize, screenStartY + ((y + yline)%screenHeight)*pixelSize, pixelSize, pixelSize, color);
							}

						}
						if (wrapping == 0)
						{
							color = CHIP8_GetPixel((x + xline)%screenWidth, (y + yline)%screenHeight) == 0U ? backColor : frontColor;							for(uint8_t px = 0; px < pixelSize; px++)
							{
								for(uint8_t py = 0; py < pixelSize; py++)
								{
									spriteBuffer[(xline*pixelSize+px) + (yline*pixelSize+py)*(width*pixelSize)] = color;
								}
							}
						}
					}
				}
				//redraw if sprite change, and we haven't redrawn previously
				if (redraw_needed && (wrapping == 0U))
				{
					RAMN_SPI_DrawImage(screenStartX + (x%screenWidth)*(uint16_t)pixelSize,screenStartY + ((y)%screenHeight)*(uint16_t)pixelSize, (uint16_t)pixelSize*width, (uint16_t)pixelSize*height, (uint8_t*)spriteBuffer);
				}
				PC += 2;

			}
			break;

			case 0xE000:
				switch (opcode & 0x00FF)
				{
				case 0x009E:
					if (CHIP8_GetKeyState(V[(opcode & 0x0F00) >> 8]) != False)
						PC += 4;
					else
						PC += 2;
					break;
				case 0x00A1:
					if (CHIP8_GetKeyState(V[(opcode & 0x0F00) >> 8]) == False)
						PC += 4;
					else
						PC += 2;
					break;
				default:
					gameStarted = False;
				}
				break;
				case 0xF000:
					switch (opcode & 0x00FF)
					{
					case 0x0007:
						V[(opcode & 0x0F00) >> 8] = delayTimer;
						PC += 2;
						break;
					case 0x000A:
					{
						/* older implementation
						if (keyWaitingRelease == 0xFF)
						{
							for (uint8_t i = 0; i < 16; i++)
							{
								if (key[i] != 0)
								{
									keyWaitingRelease = i;
									break;
								}
							}
						}
						else
						{
							//Wait for key in V
							if (key[keyWaitingRelease] == 0)
							{
								V[(opcode & 0x0F00) >> 8] = keyWaitingRelease;
								PC += 2;
								keyWaitingRelease = 0xFF;
							}
						}*/

						for (uint8_t i = 0U; i < 16U; i++)
						{
							if (CHIP8_GetKeyState(i) != False)
							{
								keysWaitingRelease |= (1 << i);  // Mark key as "waiting for release"
							}
							else
							{
								if (keysWaitingRelease & (1 << i))
								{
									//Key used to be pressed but is now released
									V[(opcode & 0x0F00) >> 8U] = i;  // Store first released key in VX
									keysWaitingRelease = 0x0000;  // Reset tracking
									PC += 2;  // Move to next instruction
									break;
								}
							}
						}
					}
					break;
					case 0x0015:
						delayTimer = V[(opcode & 0x0F00) >> 8];
						PC += 2;
						break;
					case 0x0018:
						soundTimer = V[(opcode & 0x0F00) >> 8];
						PC += 2;
						break;
					case 0x001E:
						I += V[(opcode & 0x0F00) >> 8];
						PC += 2;
						break;
					case 0x0029:
						I = FONT_ADDRESS + V[(opcode & 0x0F00) >> 8] * 0x5;
						PC += 2;
						break;
					case 0x0030:
						I = FONT_ADDRESS + 80 + V[(opcode & 0x0F00) >> 8] * 10;
						PC += 2;
						break;
					case 0x0033:
						// ensure we aren't reading outside of valid memory
						if (I + 2 >= sizeof(memory))
						{
							gameStarted = False;
							break;
						}

						memory[I] = V[(opcode & 0x0F00) >> 8] / 100;
						memory[I + 1] = (V[(opcode & 0x0F00) >> 8] / 10) % 10;
						memory[I + 2] = (V[(opcode & 0x0F00) >> 8] % 100) % 10;
						PC += 2;
						break;
					case 0x0055:
						// ensure we aren't reading outside of valid memory
						if (I + ((opcode & 0x0F00) >> 8) >= sizeof(memory))
						{
							gameStarted = False;
							break;
						}

						for (uint8_t i = 0; i <= ((opcode & 0x0F00) >> 8); i++)
							memory[I + i] = V[i];
						I += (1 + ((opcode & 0x0F00) >> 8));
						PC += 2;
						break;

					case 0x0065:
						// ensure we aren't reading outside of valid memory
						if (I + ((opcode & 0x0F00) >> 8) >= sizeof(memory))
						{
							gameStarted = False;
							break;
						}

						for (uint8_t i = 0; i <= ((opcode & 0x0F00) >> 8); i++)
							V[i] = memory[I + i];
						I += (1 + ((opcode & 0x0F00) >> 8));
						PC += 2;
						break;

					case 0x0075:
						for (uint8_t i = 0; i <= ((opcode & 0x0F00) >> 8); i++)
						{
							RPL[i] = V[i];
						}
						PC += 2;
						break;
					case 0x0085:
						for (uint8_t i = 0; i <= ((opcode & 0x0F00) >> 8); i++)
						{
							V[i] = RPL[i];
						}
						PC += 2;
						break;
					default:
						gameStarted = False;
					}
					break;
					default:
						gameStarted = False;
	}
}

void RAMN_CHIP8_RedrawScreen()
{
	uint16_t color;
	for (uint16_t xline = 0; xline < screenWidth; xline++)
	{
		for(uint16_t yline = 0; yline < screenHeight; yline++)
		{
			color = (CHIP8_GetPixel(xline,yline) == 0U) ? backColor : frontColor;
			for(uint8_t px = 0; px < pixelSize; px++)
			{
				for(uint8_t py = 0; py < pixelSize; py++)
				{
					spriteBuffer[(xline*pixelSize+px) + (yline*pixelSize+py)*(screenWidth*pixelSize)] = color;
				}
			}
		}
	}
	RAMN_SPI_DrawImage(screenStartX, screenStartY, (uint16_t)(pixelSize)*screenWidth, (uint16_t)(pixelSize)*screenHeight, (uint8_t*)spriteBuffer);
}

#endif
